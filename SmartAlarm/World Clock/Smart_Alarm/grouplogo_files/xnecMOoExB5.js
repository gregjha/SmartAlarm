if (self.CavalryLogger) { CavalryLogger.start_js(["lfsxr"]); }

__d("MessengerThreadSearchStore",["cx","immutable","Bootloader","ImmutableObject","MercuryIDs","MercuryMessages","MercurySearchContextResults","MercurySearchSnippetResults","MercuryThreads","MessengerContentSearchDataTypedLogger","MessengerContentSearchFunnelLoggerConstants","MessengerDispatcher","MessengerStateStore","MessengerStore","MessengerActions","MessengerThreadSearchActions","MessengerView"],(function a(b,c,d,e,f,g,h){"use strict";__p&&__p();var i,j,k=c("immutable").List,l=c("immutable").Record,m=c("MessengerContentSearchFunnelLoggerConstants").FUNNEL_LOGGER_EVENTS,n=m.BROWSE_CONTEXT,o=m.BROWSE_MESSAGE_IN_THREAD,p=m.LOAD_MORE_THREADS,q=m.LOAD_MESSAGE_IN_THREAD,r=m.SELECT_THREAD,s=m.THREAD_IMPRESSIONS,t=l({downExhausted:null,loading:false,messages:null,query:null,results:k(),selectedIndex:0,threadID:null,totalCount:0,upExhausted:null,threads:null,threadsExhausted:null,mid:null});i=babelHelpers.inherits(u,c("MessengerStore"));j=i&&i.prototype;function u(){j.constructor.call(this);this.$MessengerThreadSearchStore3=new t()}u.prototype.getForFBID=function(v){this.$MessengerThreadSearchStore4=new(c("MercurySearchSnippetResults"))(v);this.$MessengerThreadSearchStore1=c("MercuryMessages").getForFBID(v);this.$MessengerThreadSearchStore2=c("MercuryThreads").getForFBID(v)};u.prototype.getState=function(){return this.$MessengerThreadSearchStore3};u.prototype.__onDispatch=function(v){__p&&__p();if(!this.$MessengerThreadSearchStore4)return;c("MessengerDispatcher").waitFor([c("MessengerStateStore").getDispatchToken()]);var w=c("MessengerStateStore").getState(),x=w.activeThreadID,y=w.masterView,z=w.mid,A=w.query,B=y===c("MessengerView").MASTER.SEARCH;switch(v.type){case c("MessengerActions").Types.REPLACE_STATE:if(z!=this.$MessengerThreadSearchStore3.mid&&x!=this.$MessengerThreadSearchStore3.activeThreadID){if(z&&x){this.$MessengerThreadSearchStore3=this.$MessengerThreadSearchStore3.merge({threadID:x,mid:z});c("MercurySearchContextResults").getSearchContext(this.$MessengerThreadSearchStore7(),this.$MessengerThreadSearchStore3.threadID,function(F){return this.setMessages(F)}.bind(this))}else this.$MessengerThreadSearchStore3=new t();return}else if(this.$MessengerThreadSearchStore3.query!==A||this.$MessengerThreadSearchStore3.threadID!==x){if(A&&!z){this.$MessengerThreadSearchStore3=this.$MessengerThreadSearchStore3.set("loading",true);this.$MessengerThreadSearchStore4.getSingleThreadSearchResults(A,x,function(){for(var F=arguments.length,G=Array(F),H=0;H<F;H++)G[H]=arguments[H];return this.accumulateSearchResultsAndEmitChange.apply(this,[A,x,0].concat(G))}.bind(this))}else{if(this.$MessengerThreadSearchStore3.query&&this.$MessengerThreadSearchStore3.results.size===0)this.logCurrentResult(null,"no_results_found","single_thread_search");var C=this.$MessengerThreadSearchStore3.results.get(this.$MessengerThreadSearchStore3.selectedIndex);if(C!==undefined)this.logCurrentResult(C.toObject(),"search_ended","single_thread_search");this.$MessengerThreadSearchStore8()}if(B){this.$MessengerThreadSearchStore3=this.$MessengerThreadSearchStore3.set("loading",true);if(A!==this.$MessengerThreadSearchStore3.query){this.$MessengerThreadSearchStore6=Date.now();this.$MessengerThreadSearchStore4.getAllThreadSearchResults(A,function(F,G){this.setAllThreadResults(F,G);this.$MessengerThreadSearchStore9({name:s,threads:Object.keys(F)})}.bind(this))}else{this.$MessengerThreadSearchStore6=Date.now();this.$MessengerThreadSearchStore9({name:r,thread_id:this.$MessengerThreadSearchStore3.threadID});this.$MessengerThreadSearchStore4.getAllLocalThreadSearchResults(A,function(F,G){return this.setAllThreadResults(F,G)}.bind(this))}}else this.$MessengerThreadSearchStore10();this.emitChange()}break;case c("MessengerThreadSearchActions").Types.CHANGE_RESULT_INDEX:var D=Math.max(Math.min(this.$MessengerThreadSearchStore3.totalCount-1,this.$MessengerThreadSearchStore3.selectedIndex+v.delta),0);if(D===this.$MessengerThreadSearchStore3.selectedIndex)break;if(D>=this.$MessengerThreadSearchStore3.results.size){this.$MessengerThreadSearchStore9({name:o,thread_id:this.$MessengerThreadSearchStore3.threadID});this.$MessengerThreadSearchStore6=Date.now();this.$MessengerThreadSearchStore3=this.$MessengerThreadSearchStore3.set("loading",true);this.$MessengerThreadSearchStore4.getSingleThreadSearchMoreResults(A,x,function(){for(var F=arguments.length,G=Array(F),H=0;H<F;H++)G[H]=arguments[H];this.accumulateSearchResultsAndEmitChange.apply(this,[A,x,D].concat(G))}.bind(this))}else{this.$MessengerThreadSearchStore6=Date.now();this.$MessengerThreadSearchStore9({name:o,thread_id:this.$MessengerThreadSearchStore3.threadID});this.$MessengerThreadSearchStore3=this.$MessengerThreadSearchStore3.merge({loading:true,selectedIndex:D});c("MercurySearchContextResults").getSearchContext(this.$MessengerThreadSearchStore7(),this.$MessengerThreadSearchStore3.threadID,function(F){return this.setMessages(F)}.bind(this))}this.emitChange();var E=this.$MessengerThreadSearchStore3.results.get(D).toObject();this.logCurrentResult(E,"result_loaded","single_thread_search");this.$MessengerThreadSearchStore9({name:q,mid:E.message_id,thread_id:this.$MessengerThreadSearchStore3.threadID,latency:Date.now()-this.$MessengerThreadSearchStore6});break;case c("MessengerThreadSearchActions").Types.GET_MORE_CONTEXT:this.$MessengerThreadSearchStore3=this.$MessengerThreadSearchStore3.set("loading",true);c("MercurySearchContextResults").getMoreSearchContext(this.$MessengerThreadSearchStore7(),this.$MessengerThreadSearchStore3.threadID,v.direction,function(F){this.setMessages(F);this.$MessengerThreadSearchStore9({name:n})}.bind(this));this.emitChange();break;case c("MessengerThreadSearchActions").Types.GET_MORE_THREADS:this.$MessengerThreadSearchStore5=Date.now();this.$MessengerThreadSearchStore3=this.$MessengerThreadSearchStore3.set("loading",true);this.$MessengerThreadSearchStore4.getAllThreadSearchMoreResults(A,function(F,G){this.$MessengerThreadSearchStore9({name:p,threads:Object.keys(F),latency:Date.now()-this.$MessengerThreadSearchStore5});this.setAllThreadResults(F,G)}.bind(this));this.emitChange();break}};u.prototype.logCurrentResult=function(v,w,x){var y=new(c("MessengerContentSearchDataTypedLogger"))().setSearchTerm(this.$MessengerThreadSearchStore3.query).setThreadFbid(c("MercuryIDs").getThreadFBIDFromThreadID(this.$MessengerThreadSearchStore3.threadID)).setNumResults(this.$MessengerThreadSearchStore3.results.size).setSearchOutcome(w).setSearchType(x);if(v!==undefined&&v!==null)y.setMessageID(v.message_id).setMessageTimestamp(v.timestamp).setResultIndex(this.$MessengerThreadSearchStore3.selectedIndex+1);y.log()};u.prototype.setAllThreadResults=function(v,w){__p&&__p();var x=Object.keys(v),y=x.map(function(z){var A=this.$MessengerThreadSearchStore2.getThreadMetaNow(z);if(!A)return;var B=v[A.thread_id];if(!B)return;return new(c("ImmutableObject"))(babelHelpers["extends"]({},A,{snippetCount:B.num_total_snippets}))}.bind(this)).filter(function(z){return z});this.$MessengerThreadSearchStore3=this.$MessengerThreadSearchStore3.merge({threads:y,threadsExhausted:w,loading:false});this.emitChange()};u.prototype.$MessengerThreadSearchStore10=function(){this.$MessengerThreadSearchStore11(["threads","threadsExhausted","loading"])};u.prototype.accumulateSearchResultsAndEmitChange=function(v,w,x,y,z){__p&&__p();this.$MessengerThreadSearchStore3=this.$MessengerThreadSearchStore3.merge({query:v,threadID:w,selectedIndex:x,results:y,totalCount:z});if(this.$MessengerThreadSearchStore3.results.size){c("MercurySearchContextResults").getSearchContext(this.$MessengerThreadSearchStore7(),this.$MessengerThreadSearchStore3.threadID,function(y){return this.setMessages(y)}.bind(this));var A=this.$MessengerThreadSearchStore3.results.get(this.$MessengerThreadSearchStore3.selectedIndex);this.$MessengerThreadSearchStore9({name:q,mid:A.toObject().message_id,thread_id:this.$MessengerThreadSearchStore3.threadID,latency:Date.now()-this.$MessengerThreadSearchStore6});this.logCurrentResult(A.toObject(),"search_started","single_thread_search")}else this.$MessengerThreadSearchStore3=this.$MessengerThreadSearchStore3.merge({messages:null});this.emitChange()};u.prototype.$MessengerThreadSearchStore8=function(){this.$MessengerThreadSearchStore11(["query","threadID","selectedIndex","results","totalCount","downExhausted","loading","messages","upExhausted"])};u.prototype.$MessengerThreadSearchStore11=function(v){this.$MessengerThreadSearchStore3=this.$MessengerThreadSearchStore3.withMutations(function(w){v.forEach(function(x){return w.remove(x)})})};u.prototype.setMessages=function(v){__p&&__p();var w=this.$MessengerThreadSearchStore1.getMessagesFromIDs([].concat(v.up_message_ids,v.message_id,v.down_message_ids)).map(function(x){__p&&__p();var y,z=this;if(x&&x.message_id===v.message_id)if(!this.$MessengerThreadSearchStore3.results.isEmpty()){var y=function(){var A=z.$MessengerThreadSearchStore3.results.get(z.$MessengerThreadSearchStore3.selectedIndex).toJS(),B=A.matched_keywords,C=x.body.indexOf(A.body),D=Object.keys(A.matched_keywords).map(function(E){return{offset:C+Number(E),length:B[E].length,entity:{url:""},className:"__in"}});return{v:new(c("ImmutableObject"))(babelHelpers["extends"]({},x,{ranges:x.ranges?x.ranges.concat(D):D}))}}();if(typeof y==="object")return y.v}else return new(c("ImmutableObject"))(babelHelpers["extends"]({},x,{isSelected:true}));return x}.bind(this));this.$MessengerThreadSearchStore3=this.$MessengerThreadSearchStore3.merge({downExhausted:v.down_exhausted,loading:false,messages:w,upExhausted:v.up_exhausted});this.emitChange()};u.prototype.$MessengerThreadSearchStore7=function(){return this.$MessengerThreadSearchStore3.mid||this.$MessengerThreadSearchStore3.results.getIn([this.$MessengerThreadSearchStore3.selectedIndex,"message_id"])};u.prototype.$MessengerThreadSearchStore9=function(event){__p&&__p();c("Bootloader").loadModules(["MessengerContentSearchFunnelLogger"],function(v){__p&&__p();if(v&&event)switch(event.name){case o:v.browseMessageInThread(event.thread_id);break;case p:v.logLoadMoreThreads(event.threads,event.latency);break;case r:v.logThreadSelect(event.thread_id);break;case q:v.loadMessageInThread(event.mid,event.thread_id,event.latency);break;case s:v.logThreadImpressions(event.threads);break;case n:v.logContextBrowse();break}},"MessengerThreadSearchStore")};f.exports=new u()}),null);