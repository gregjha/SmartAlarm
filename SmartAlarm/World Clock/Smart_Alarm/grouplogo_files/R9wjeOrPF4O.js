if (self.CavalryLogger) { CavalryLogger.start_js(["1Gief"]); }

__d("OmniMReducer",["AsyncRequest","immutable","MercuryActionType","MercuryConfig","MercuryIDs","MercuryPayloadSource","MNOmniMConstants","OmniMActions","OmniMActionType","OmniMDirectiveType","OmniMLogHelpers","P2PGKValues","XMessagingOmniMSetPrefController","gkx"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();var h,i=c("OmniMActions").Types,j=c("immutable").Set([c("MercuryActionType").SEND_MESSAGE,c("MercuryActionType").REPLACE_MESSAGE,c("MercuryActionType").USER_GENERATED_MESSAGE]),k=c("immutable").Set([c("MercuryActionType").SEND_MESSAGE,c("MercuryActionType").USER_GENERATED_MESSAGE]),l=2;function m(O,P){__p&&__p();switch(O.content_type){case"text":return true;case"location":if(P===c("MNOmniMConstants").OMNIM)return c("gkx")("AT5s572MdSoGEXfamGtrehqpxjFf-azU_ge5vN8Ha2cmR4nQsJAHf7S6z00TDkUIlOeInYrNbQk1we_dd2i0BgNU");return true;case"sticker":return c("gkx")("AT7VmDDGPaDT6LbLmd3xB0SD2q65kDsRg8icyePF-ojDYKmKCyM5D7bic2sLW9soU6evorr3A-mtzIzJGbizZ7KARzV08bcnfQEcURsfvuJl_g");case"ride_service":return c("gkx")("AT4FiiMAoYveJBlfzyLMiS1Iq4sQkdORShpZQHlNrMkpD7KPwIB3v3LFXtUGAntwinuEZpeidQ2a3vqe12jFyUACAOeBKCvP-1oKVrd31njqmA");case"p2p_payment":return c("P2PGKValues").P2PVisible&&c("gkx")("AT4Pia7DoVl_8Dgx0eX7OE67F1fDbBMFoFb-15ApKSTB7VFr4t2jxpJw8uigJ39qdqTgbGxrjNI7eL3wFjXGNOTq4D_dbLNpHineyfxooIc-MQ");case"open_camera":return c("gkx")("AT5fg4UYOTOQqJSrKF0G7HM1Q9p8lrAP-AUQoEIPGsNAGCXoeNUX9105PDW5_9iyjGg0X2xdaTO7cns3uXkVmE7wDIY7ok4wSTxXRh8vQhJjHQ");case"record_audio":return c("gkx")("AT7LaNJ2-hsszbpnh8CbBanAoNNMygGDk2RRyqBRC8z-zrCRaZrPk8otAH1W6sEv4cue9dKD_xRWmCcplGybp5gI0hUlnFtMsCzXrdE4BH1yUg");case"user_phone_number":return c("gkx")("AT70ApPO8u4r9N24CdWkIiFYZMdcnAaeV9BaXzLxdBmkmVf60X7teW8bfJTrYYnPlB7TPT4_aBOsOQDbCdO-mpJj4JY2rmmLkTH2jaDU2xAiSg");case"user_email":return c("gkx")("AT6b68OqbLsWJQlJTGZqwlCTZJ0z0taRGUXqOzuQVRDoLPO2Dnjh-maTANaNF_FUgpVzi4qt9-S_T7GMqZpzzd99");default:return false}}function n(O){return Array.isArray(O)}function o(O){if(!O)return{};var P=JSON.parse(O)||{},Q=n(P.quick_replies)?P.quick_replies:[],R=P.m_directives;return{quickReplies:Q,directives:R}}function p(O){var P=O.other_user_fbid,Q=O.thread_fbid;return P?c("MercuryIDs").getThreadIDFromUserID(P):c("MercuryIDs").getThreadIDFromThreadFBID(Q)}var q=c("immutable").Map((h={},h[c("OmniMActionType").CREATE_EVENT]="create_event",h[c("OmniMActionType").LOCATION]="location",h[c("OmniMActionType").PAYMENT]="p2p_payment",h[c("OmniMActionType").POLL]="poll",h[c("OmniMActionType").STICKER]="sticker",h[c("OmniMActionType").TEXT]="text",h[c("OmniMActionType").TRANSPORTATION]="ride_service",h[c("OmniMActionType").ORDER_FOOD]="order_food",h[c("OmniMActionType").MAKE_RESERVATION]="make_reservation",h[c("OmniMActionType").SCHEDULE_CALL]="schedule_call",h[c("OmniMActionType").LIVE_LOCATION]="live_location",h));function r(O){var P=O.confidence,Q=O.id,R=O.label,S=O.type,T=O.data,U=O.icon,V=O.message_id,W=O.thread_key;return{content_type:q.get(S+""),data:T,image_url:U,title:R,confidence:P,messageID:V,suggestionID:Q,threadID:p(W),messageDepth:1}}function s(O,P){__p&&__p();var Q=o(P),R=(Q.quickReplies||[]).filter(function(T){return m(T,c("MNOmniMConstants").QUICKREPLIES)}),S=(Q.directives||[]).filter(function(T){return T.type===c("OmniMDirectiveType").ADD_ACTIONS}).map(function(T){return T.data.actions}).reduce(function(T,U){return T.concat(U)},[]).map(r).filter(function(T){return m(T,c("MNOmniMConstants").OMNIM)}).reduce(function(T,U){var V=U.threadID;return T.updateIn([V,"agentSuggestions"],[],function(W){return W.concat([U])})},c("immutable").Map({}));return S.setIn([O,"quickReplies"],R)}function t(O){var P=O.content_type;Object.keys(O.data||{}).sort().map(function(Q){P+=""+Q+O.data[Q]});return P}function u(O){var P=c("immutable").Set(),Q=[];for(var R=O.length-1;R>=0;R--){var S=O[R],T=t(S);if(!P.has(T)){P=P.add(T);Q.unshift(S)}}return Q}function v(O){var P=0;return O.filter(function(Q){if(Q.content_type==="sticker"){if(P>=l)return false;P+=1}return true})}function w(O,P,Q,R){var S=O.getIn(["threadMetadata",P,"timestamp"]);if(S&&S>R)return O;var T=Q.agentSuggestions,U=Q.quickReplies,V=(O.getIn(["suggestionsByThread",P])||{}).agentSuggestions||[],W=T||[];if(V.length)W=v(W);var X=u(W.concat(V));return O.setIn(["threadMetadata",P,"timestamp"],R).setIn(["suggestionsByThread",P],{agentSuggestions:X,quickReplies:U})}function x(O,P,Q,R,S){var T=s(P,R);return T.reduce(function(U,V,P){return w(U,P,V.toJS(),S)},O)}function y(O){if(!O)return null;var P=O.agentSuggestions,Q=(P||[]).reduce(function(R,S){if(S.messageDepth>=c("MercuryConfig").OmniMMessagesToLive)return R;return R.concat([babelHelpers["extends"]({},S,{messageDepth:S.messageDepth+1})])},[]);return babelHelpers["extends"]({},O,{agentSuggestions:Q})}function z(O,P){var Q=P.thread_id,R=P.message_id,S=P.platform_xmd,T=P.timestamp;if(k.has(P.action_type))O=O.updateIn(["suggestionsByThread",Q],y);return x(O,Q,R,S,T)}function A(O,P){__p&&__p();if(P.type!==i.MERCURY_DISPATCHED)return O;var Q=P.data;switch(P.mercuryType){case"update-messages":if(Q.payload_source!==c("MercuryPayloadSource").CLIENT_CHANNEL_MESSAGE)return O;return Q.actions.filter(function(R){return j.has(R.action_type)}).reduce(z,O);case"invalidate-thread-state":return O.deleteIn(["suggestionsByThread",Q.threadID]).deleteIn(["threadMetadata",Q.threadID]);case"invalidate-global-state":return O.set("suggestionsByThread",c("immutable").Map()).set("threadMetadata",c("immutable").Map())}return O}function B(O,P){if(P.type!==i.FETCH_SUGGESTIONS)return O;var Q=P.message,R=P.threadID;return x(O,R,Q.message_id,Q.platform_xmd,Q.timestamp)}function C(O){return O.getIn(["prefs","suggestion_mode"],0)}function D(O,P){if(P.type!==i.SUGGESTION_CLICKED)return O;var Q=P.option,R=P.position,S=P.source;if(S===c("MNOmniMConstants").OMNIM)c("OmniMLogHelpers").suggestionClicked(Q,R,C(O));return O}function E(O,P){if(P.type!==i.SUGGESTION_COMPLETED)return O;var Q=P.threadID,R=P.option,S=P.position,T=P.source;if(T===c("MNOmniMConstants").OMNIM)c("OmniMLogHelpers").suggestionCompleted(R,S,C(O));return O.deleteIn(["suggestionsByThread",Q])}function F(O,P){__p&&__p();if(P.type!==i.SUGGESTION_DISMISSED)return O;var Q=P.threadID,R=P.option,S=P.source,T=P.position;if(S===c("MNOmniMConstants").OMNIM)c("OmniMLogHelpers").suggestionDismissed(R,T,C(O));var U=O.getIn(["suggestionsByThread",Q]);if(!U||!U.agentSuggestions)return O;var V=U.agentSuggestions.map(function(W){if(W.suggestionID===R.suggestionID)return babelHelpers["extends"]({},W,{dismissed:true});return W});return O.setIn(["suggestionsByThread",Q],babelHelpers["extends"]({},U,{agentSuggestions:V}))}function G(O,P){__p&&__p();if(P.type!==i.SUGGESTIONS_DISMISSED_FOR_THREAD)return O;var Q=P.threadID,R=O.getIn(["suggestionsByThread",Q]);if(!R||!R.agentSuggestions)return O;c("OmniMLogHelpers").barDismissed(R.agentSuggestions,C(O));var S=R.agentSuggestions.map(function(T,U){if(T.dismissed)return T;c("OmniMLogHelpers").suggestionDismissed(T,U,C(O));return babelHelpers["extends"]({},T,{dismissed:true})});return O.setIn(["suggestionsByThread",Q],babelHelpers["extends"]({},R,{agentSuggestions:S}))}function H(O,P){if(P.type!==i.PREFS_UPDATED)return O;var Q=P.prefs;return O.updateIn(["prefs"],function(R){return R.merge(c("immutable").fromJS(Q))})}function I(O,P){if(P.type!==i.SUGGESTION_MODE_SET)return O;var Q=P.mode,R=c("XMessagingOmniMSetPrefController").getURIBuilder().getURI();new(c("AsyncRequest"))(R).setMethod("POST").setData({suggestion_mode:Q}).send();return O.setIn(["prefs","suggestion_mode"],Q)}function J(O,P){if(P.type!==i.SUGGESTION_DISPLAYED)return O;var Q=P.option,R=P.position;if(!Q.dismissed)c("OmniMLogHelpers").suggestionDisplayed(Q,R,C(O));return O}function K(O,P){if(P.type!==i.SUGGESTION_DISAPPEARED)return O;var Q=P.option,R=P.position;if(!Q.dismissed)c("OmniMLogHelpers").suggestionDisappeared(Q,R,C(O));return O}function L(O,P){if(P.type!==i.BAR_TIMED_OUT)return O;var Q=P.threadID,R=P.options;c("OmniMLogHelpers").barDisappeared(R,C(O));return O.deleteIn(["suggestionsByThread",Q])}function M(O,P){if(P.type!==i.BAR_DISAPPEARED)return O;c("OmniMLogHelpers").barDisappeared(P.options,C(O));return O}function N(O,P){if(P.type!==i.BAR_DISPLAYED)return O;c("OmniMLogHelpers").barDisplayed(P.options,C(O));return O}f.exports={barDisappeared:M,barDisplayed:N,barTimedOut:L,mercuryDispatch:A,messageFetched:B,prefsUpdated:H,suggestionClicked:D,suggestionCompleted:E,suggestionDisappeared:K,suggestionDismissed:F,suggestionDisplayed:J,suggestionModeSet:I,suggestionsDismissedForThread:G}}),null);