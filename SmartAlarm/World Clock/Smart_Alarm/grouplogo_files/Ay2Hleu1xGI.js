if (self.CavalryLogger) { CavalryLogger.start_js(["EBRPs"]); }

__d("ChannelConnection",["Arbiter","ChannelConstants","ChannelManager","JSLogger","Run","SystemEvents","Visibility","setTimeoutAcrossTransitions"],(function a(b,c,d,e,f,g){__p&&__p();var h=c("JSLogger").create("channel_connection"),i=null,j=null,k=null,l=null,m=0;c("ChannelManager").startChannelManager();var n=Object.assign(new(c("Arbiter"))(),{CONNECTED:"chat-connection/connected",RECONNECTING:"chat-connection/reconnecting",SHUTDOWN:"chat-connection/shutdown",MUTE_WARNING:"chat-connection/mute",UNMUTE_WARNING:"chat-connection/unmute"});c("Run").onBeforeUnload(function(){});function o(){if(j){clearTimeout(j);j=null}}function p(){o();h.log("unmute_warning");n.inform(n.UNMUTE_WARNING)}function q(v){o();j=c("setTimeoutAcrossTransitions")(p,v);h.log("mute_warning",{time:v});n.inform(n.MUTE_WARNING)}function r(){if(k){clearTimeout(k);k=null}}function s(v,w){__p&&__p();r();if(v===c("ChannelConstants").ON_ENTER_STATE&&(w.nextState||w.state)==="pull"){if(l!==n.CONNECTED){h.log("connected");var x=!l;l=n.CONNECTED;m=0;n.inform(n.CONNECTED,{init:x})}}else if(v===c("ChannelConstants").ON_ENTER_STATE&&((w.nextState||w.state)==="ping"||!w.nextState&&w.state==="idle"))k=c("setTimeoutAcrossTransitions")(function(){__p&&__p();var y=null;if(!(w.state==="idle"&&!w.nextState))y=w.delay||0;h.log("reconnecting",{delay:y});if(n.disconnected())h.log("reconnecting_ui",{delay:y});l=n.RECONNECTING;w.state==="idle"&&m++;if(m>1)n.inform(n.RECONNECTING,y);else if(!w.nextState&&w.state==="idle")s(v,w)},500);else if(v===c("ChannelConstants").ON_SHUTDOWN){h.log("shutdown",{reason:w.reason});l=n.SHUTDOWN;m=0;n.inform(n.SHUTDOWN,w.reason)}}function t(){if(c("ChannelManager").isShutdown())s(c("ChannelConstants").ON_SHUTDOWN,c("ChannelManager")._shutdownHint);else s(c("ChannelConstants").ON_ENTER_STATE,{state:c("ChannelManager").state,nextState:c("ChannelManager").nextState,delay:0});c("Visibility").addListener(c("Visibility").VISIBLE,n.reconnect)}c("Run").onAfterLoad(t);Object.assign(n,{disconnected:function v(){return l===n.SHUTDOWN||l===n.RECONNECTING&&!j&&m>1},isShutdown:function v(){return l===n.SHUTDOWN},reconnect:function v(w){__p&&__p();if(c("ChannelManager").state==="ping"||c("ChannelManager").state==="pull"||c("ChannelManager").isShutdown())return;h.log("reconnect",{now:w});n.inform(n.RECONNECTING,0);if(!!w){if(i!==null){clearTimeout(i);i=null}c("ChannelManager").enterState("ping!")}else if(!i)i=c("setTimeoutAcrossTransitions")(function(){c("ChannelManager").enterState("ping!");i=null},c("ChannelConstants").CHANNEL_MANUAL_RECONNECT_DEFER_MSEC);c("ChannelManager").resetDelay()},unmuteWarning:p});function u(){c("Arbiter").subscribe([c("ChannelConstants").ON_ENTER_STATE,c("ChannelConstants").ON_SHUTDOWN],s);c("Arbiter").subscribe(c("ChannelConstants").ATTEMPT_RECONNECT,function(){if(n.disconnected())n.reconnect()});c("SystemEvents").subscribe(c("SystemEvents").TIME_TRAVEL,function(){n.reconnect();q(c("ChannelConstants").MUTE_WARNING_TIME_MSEC)});c("Run").onBeforeUnload(r,false)}c("Run").onAfterLoad(u);n.mockAfterLoad=function(){t();u()};c("Arbiter").subscribe(c("JSLogger").DUMP_EVENT,function(v,w){w.channel_connected=!n.disconnected()});f.exports=n}),3);