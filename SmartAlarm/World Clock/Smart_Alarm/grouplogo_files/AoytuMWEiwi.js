if (self.CavalryLogger) { CavalryLogger.start_js(["TdgAD"]); }

__d("MessengerDetailView.react",["cx","fbt","invariant","Bootloader","BootloadOnRender.react","CustomColorHighlighting.react","DataTransfer","EventReminderActions","EventRemindersGating","EventReminderStateStore","immutable","JSResource","LazyComponent.react","MercuryIDs","MercuryConfig","MercuryCanonicalGroupThreadStore","MercuryParticipants","MercuryThreadActions","MercuryThreadInfo","MercuryThreads","MessengerActions","MessengerComposerStore","MessengerComposerContainer.react","MessengerConversation.react","MessengerConversationContainer.react","MessengerDetailViewHeaderContainer.react","messengerDomIDsRe","MessengerErrorBoundary.react","MessengerPresenceStatusUtils","MessengerSettingsActions","MessengerSettingsStore","MessengerStateStore","MessengerThreadSearchStore","MessengerThreadInfoPanelContainer.react","MessengerThreadSearchActions","MessengerView","MessengerWebDriverTestIDs","Parent","PresenceStatus","React","SubscriptionsHandler","AvailableList","emptyFunction","gkx","ifRequired","shallowCompare"],(function a(b,c,d,e,f,g,h,i,j){"use strict";__p&&__p();var k=c("messengerDomIDsRe").ids;c("AvailableList");var l=c("React").PropTypes;function m(event,o,p,q){if(!c("EventRemindersGating").shouldShowPlansOnMessengerCom)return null;if(!o)return null;if(!event)return null;return c("React").createElement(c("BootloadOnRender.react"),{loader:c("JSResource")("MessengerEventPlanContainer.react").__setRef("MessengerDetailView.react"),placeholder:c("React").createElement("div",null),component:c("React").createElement(c("LazyComponent.react"),{threadID:o,participants:p,viewer:q})})}var n=c("React").createClass({displayName:"MessengerDetailView",_composer:undefined,_refsConversationContainer:null,_subscriptionsHandler:new(c("SubscriptionsHandler"))(),propTypes:{activeThreadID:l.string,view:l.string,viewer:l.string.isRequired},calculateState:function o(p){__p&&__p();var q=p.activeThreadID,r=c("MercuryThreads").getForFBID(p.viewer),s=c("MessengerComposerStore").getState();if(p.view===c("MessengerView").DETAIL.COMPOSE){!!s.recipients||j(0);var t=s.recipients;if(t.size===1)q=c("MercuryIDs").getThreadIDFromUserID(t.first().getUniqueID().toString());else if(t.size>1)q=c("MercuryCanonicalGroupThreadStore").getOrFetch(Array.from(t).map(function(z){return z.getUniqueID().toString()}))}var u=q?r.getOrFetch(q):null,v=c("immutable").Map();if(u&&q){v=v.withMutations(function(z){u.participants&&u.participants.forEach(function(A){z.set(A,c("MercuryParticipants").getOrFetch(A))});u.is_subscribed&&z.set(c("MercuryIDs").getParticipantIDFromUserID(p.viewer),c("MercuryParticipants").getOrFetch(c("MercuryIDs").getParticipantIDFromUserID(p.viewer)))});if(c("EventRemindersGating").shouldShowPlansOnMessengerCom){var event=u?u.lightweight_event:null;if(event)c("EventReminderActions").updateEventReminder(q,event);else{var w=c("EventReminderStateStore").getEvent(q);if(w&&w.exists)c("EventReminderActions").deleteEventReminder(q)}}}var x=c("ifRequired")("MessengerUploadFilesStore",function(z){return z.getState()},function(){return c("immutable").Map({})}),y=c("ifRequired")("MessengerSharePreviewStore",function(z){return z.getState()},function(){return c("immutable").Map({})});return{infoPanelCollapsed:c("MessengerSettingsStore").getSettings().info_sidebar_collapsed,activeThreadID:q,composerState:s,messengerState:c("MessengerStateStore").getState(),contactData:c("MessengerPresenceStatusUtils").getStatusFromCanonicalThread(v,u),activeThread:u,participants:v,searchResults:c("MessengerThreadSearchStore").getState(),uploadFilesState:x,sharePreivewState:y}},getInitialState:function o(){return babelHelpers["extends"]({dropTargetOverlayVisible:false},this.calculateState(this.props))},componentWillMount:function o(){this._subscribeToSubscrptionHandler([c("MessengerComposerStore"),c("MessengerStateStore"),c("MessengerThreadSearchStore"),c("MercuryCanonicalGroupThreadStore"),c("MercuryThreads"),c("MercuryParticipants"),c("PresenceStatus")])},componentDidMount:function o(){if(c("gkx")("AT5V6GuV7OE1f4CNmq1NUhZOeDrgnZF-AQ7WoOvZA8jFMJsYzyghwU79Bm31vgH-mi9DAlUGSFnfYvhwjhMfTolYEEzHhgUrhLD2UxTqbooHHw"))c("Bootloader").loadModules(["MessengerUploadFilesStore"],function(p){this._subscribeToSubscrptionHandler([p])}.bind(this),"MessengerDetailView.react");if(c("gkx")("AT5M-KOnq98igVULtzbIXLLujZOrcPEb_vzPxIrrMO4yDC59FjeQpdoZs2nMsaoB9WIY9SOWsfOkycr87iOYdoQQ"))c("Bootloader").loadModules(["MessengerSharePreviewStore"],function(p){this._subscribeToSubscrptionHandler([p])}.bind(this),"MessengerDetailView.react")},_subscribeToSubscrptionHandler:function o(p){__p&&__p();var q=function(){this.setState(this.calculateState(this.props))}.bind(this),r=[];p.forEach(function(t){if(t.hasChanged&&t.getDispatchToken&&t.addListener)r.push(t.addListener(q));else if(t.subscribe)r.push(t.subscribe("change",q));else if(t.addListener)r.push(t.addListener("change",q));else j(0)});if(r.length>0){var s;this._subscriptionsHandler&&(s=this._subscriptionsHandler).addSubscriptions.apply(s,r)}},shouldComponentUpdate:function o(p,q){return c("shallowCompare")(this,p,q)},componentDidUpdate:function o(){this._handleResize()},componentWillUnmount:function o(){this._subscriptionsHandler&&this._subscriptionsHandler.release();this._subscriptionsHandler=null},componentWillReceiveProps:function o(p){this.setState(this.calculateState(p))},render:function o(){var p=this.state.activeThreadID,q=this._getMainLabelDetails(),r=void 0;if(this.state.activeThread)r=this.props.query==null?m(this.state.activeThread.lightweight_event,p,this.state.participants,this.props.viewer):null;return c("React").createElement("div",{"aria-labelledby":q.labelIDs,className:"_1q5-",role:"main"},c("React").createElement("div",{className:"hidden_elem",id:k.MAIN_LABEL},q.labelText),c("React").createElement(c("CustomColorHighlighting.react"),{className:"_wsc",customColor:this.state.activeThread&&this.state.activeThread.custom_color},c("React").createElement(c("MessengerDetailViewHeaderContainer.react"),{contactData:this.state.contactData,recipients:this.state.composerState.recipients,participants:this.state.participants,thread:this.state.activeThread,view:this.props.view,viewer:this.props.viewer,onResize:this._handleResize,onInfoPanelToggle:this._handleInfoPanelToggle,infoPanelCollapsed:this.state.infoPanelCollapsed}),c("React").createElement("div",{className:"_20bp"},this._renderInfoPanel(),c("React").createElement("div",{className:"_4_j4",onClick:this._handleConversationClick,onDragEnter:this._showDropTargetOverlay,onDragLeave:this._hideDropTargetOverlay,onDragOver:this._showDropTargetOverlay,onDrop:this._handleDrop,role:"presentation"},this._renderMainView(p),r,this._renderSearchView(p),this._renderFooterView(p),c("React").createElement("div",{className:(!this.state.dropTargetOverlayVisible?"hidden_elem":"")+" _2fg6"}),(c("gkx")("AT5V6GuV7OE1f4CNmq1NUhZOeDrgnZF-AQ7WoOvZA8jFMJsYzyghwU79Bm31vgH-mi9DAlUGSFnfYvhwjhMfTolYEEzHhgUrhLD2UxTqbooHHw")||c("gkx")("AT5M-KOnq98igVULtzbIXLLujZOrcPEb_vzPxIrrMO4yDC59FjeQpdoZs2nMsaoB9WIY9SOWsfOkycr87iOYdoQQ"))&&this._renderUploadFiles(p)))))},_renderUploadFiles:function o(p){if(!p)return null;var q=this.state.uploadFilesState.get(p)||{},r=this.state.sharePreivewState.get(p);return c("React").createElement(c("BootloadOnRender.react"),{loader:c("JSResource")("FantaDragAndDrop.react").__setRef("MessengerDetailView.react"),placeholder:c("React").createElement("div",null),component:c("React").createElement(c("LazyComponent.react"),{threadID:p,uploadedFiles:q.uploadedFiles,uploadingFiles:q.uploadingFiles,sharePreview:r})})},_renderSearchView:function o(p){return p&&!this.props.mid&&this.props.query!=null?c("React").createElement(c("BootloadOnRender.react"),{loader:c("JSResource")("MessengerThreadSearchContainer.react").__setRef("MessengerDetailView.react"),placeholder:c("React").createElement("div",{className:"_33p7 _5iwm"}),component:c("React").createElement(c("LazyComponent.react"),{loading:this.state.searchResults.loading,query:this.state.searchResults.query,selectedIndex:this.state.searchResults.selectedIndex,totalCount:this.state.searchResults.totalCount})}):null},_assignConversationContainerRef:function o(p){this._refsConversationContainer=p},_renderMainView:function o(p){if(!p)return c("React").createElement("div",{className:"_1ut7"});var q=this.state.contactData?this.state.contactData.contact:null;if(this.state.searchResults.messages)return c("React").createElement(c("MessengerErrorBoundary.react"),{component:"conversation"},c("React").createElement(c("MessengerConversation.react"),{className:"_1wfr",contact:q,downExhausted:this.state.searchResults.downExhausted,fetchMessages:c("MessengerThreadSearchActions").getMoreSearchContext,onVoiceClipCreate:this.handleAudioUpload,innerClassName:"_1r_-",isCanonical:c("MercuryIDs").isCanonical(p),isLoaded:true,isLoading:false,messages:this.state.searchResults.messages,onRead:c("emptyFunction"),participants:this.state.participants,thread:this.state.activeThread,threadID:p,upExhausted:this.state.searchResults.upExhausted,useManualFetch:true,viewer:this.props.viewer}));return c("React").createElement(c("MessengerErrorBoundary.react"),{component:"conversation"},c("React").createElement(c("MessengerConversationContainer.react"),{className:"_1wfr",contact:q,onVoiceClipCreate:this.handleAudioUpload,onMarkRead:this._handleMarkRead,participants:this.state.participants,ref:this._assignConversationContainerRef,thread:this.state.activeThread,threadID:p,viewer:this.props.viewer}))},_renderFooterView:function o(p){var q=c("MercuryConfig").ColdOpenBlock&&this.state.activeThread&&c("MercuryThreadInfo").isColdOpen(this.state.activeThread);return c("React").createElement(c("MessengerErrorBoundary.react"),{className:"_4rv3 _2pen",component:"composer"},c("React").createElement(c("MessengerComposerContainer.react"),{canReply:!!(!q&&(this.props.view===c("MessengerView").DETAIL.COMPOSE||this.state.activeThread&&c("MercuryThreadInfo").canReply(this.state.activeThread)&&!c("MercuryConfig").ViewerIsReadOnly)),fileUploader:this.state.uploadFilesState.get(p),onMount:function(r){return this._composer=r}.bind(this),onResize:this._handleResize,participants:this.state.participants,recipients:this.state.composerState.recipients,sharePreview:this.state.sharePreivewState.get(p),threadID:p,threadFBID:this.state.activeThread?this.state.activeThread.thread_fbid:null,thread:this.state.activeThread,view:this.props.view,viewer:this.props.viewer}))},_renderInfoPanel:function o(){var p=this.state,q=p.activeThread,r=p.contactData,s=p.infoPanelCollapsed,t=p.participants,u=this.props.view;if(!q||!t||u===c("MessengerView").DETAIL.COMPOSE)return null;return c("React").createElement("div",{className:(s?"hidden_elem":"")+" _4_j5","data-testid":c("MessengerWebDriverTestIDs").INFO_PANEL},c("React").createElement(c("MessengerErrorBoundary.react"),{className:"_4rv3",component:"conversation information"},c("React").createElement(c("MessengerThreadInfoPanelContainer.react"),{className:"_4_j9",contactData:r,participants:t,thread:q,viewer:this.props.viewer})))},_getMainLabelDetails:function o(){if(this.props.view===c("MessengerView").DETAIL.COMPOSE)return{labelText:i._("New Message"),labelIDs:k.MAIN_LABEL};return{labelText:i._("Conversation with"),labelIDs:k.MAIN_LABEL+" "+k.THREAD_TITLE}},_handleConversationClick:function o(p){__p&&__p();var q=this.props.activeThreadID;if(q&&this._refsConversationContainer&&this._refsConversationContainer.isScrolledToBottom())this._handleMarkRead(q);if(window.getSelection().toString()!=="")return;var r=p.target;if(r instanceof Node&&c("Parent").byTag(r,"a")!=null)return;var s=this._getComposer();s&&s.focusInput()},handleAudioUpload:function o(p){var q=this._getComposer();if(q!=null&&p!=null){q.handleAudioUpload(p);q.focusInput()}},_showDropTargetOverlay:function o(p){p&&p.preventDefault();this.setState({dropTargetOverlayVisible:true})},_hideDropTargetOverlay:function o(p){p&&p.preventDefault();this.setState({dropTargetOverlayVisible:false});var q=this._getComposer();q&&q.resetDrag()},_handleDrop:function o(p){__p&&__p();this._hideDropTargetOverlay(p);var q=this._getComposer();if(!q)return;p.nativeEvent.dataTransfer instanceof Object||j(0);if(c("gkx")("AT5V6GuV7OE1f4CNmq1NUhZOeDrgnZF-AQ7WoOvZA8jFMJsYzyghwU79Bm31vgH-mi9DAlUGSFnfYvhwjhMfTolYEEzHhgUrhLD2UxTqbooHHw")){c("MessengerActions").prepareFilesForSend(this.state.activeThreadID,p.nativeEvent.dataTransfer.files);return}var r=new(c("DataTransfer"))(p.nativeEvent.dataTransfer),s=r.getFiles();if(s.length)q.handleFileUpload(s);else{var t=r.getText();if(t)q.handleTextDropped(t)}},_handleResize:function o(){var p=this._refsConversationContainer;if(p)p.handleResize()},_handleInfoPanelToggle:function o(){var p=!this.state.infoPanelCollapsed;this.setState({infoPanelCollapsed:p},function(){c("MessengerSettingsActions").changeSettings({info_sidebar_collapsed:p})})},_handleMarkRead:function o(p){c("MercuryThreadActions").getForFBID(this.props.viewer).markRead(p)},_getComposer:function o(){return this._composer}});f.exports=n}),null);