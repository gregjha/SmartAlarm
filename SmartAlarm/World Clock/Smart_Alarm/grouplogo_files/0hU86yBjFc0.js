if (self.CavalryLogger) { CavalryLogger.start_js(["SWmJe"]); }

__d("MercuryNotificationRenderer",["fbt","MercuryAssert","MercuryIDs","MercuryMessages","MercuryParticipants","MercuryThreads","MercuryViewer","MessagingGenericAdminTextType"],(function a(b,c,d,e,f,g,h){__p&&__p();var i=c("MercuryMessages").get(),j=c("MercuryThreads").get(),k="source:messenger_growth:event_upcoming_bump";function l(m,n){__p&&__p();c("MercuryAssert").isThreadID(m);j.getThreadMeta(m,function(o){__p&&__p();i.getThreadMessagesRange(m,0,1,function(p){__p&&__p();var q=p.length&&p[p.length-1],r=[];if(q.tags!==undefined)r=r.concat(q.tags);if(q.log_message_data&&(q.log_message_data.message_type==c("MessagingGenericAdminTextType").CONFIRM_FRIEND_REQUEST||q.log_message_data.message_type==c("MessagingGenericAdminTextType").WORK_INVITE_CLAIMED))n(h._("New contact added"));else if(r.indexOf(k)!==-1)n(h._("You have an upcoming event."));else if(q&&q.author!=c("MercuryViewer").getID())c("MercuryParticipants").get(q.author,function(s){__p&&__p();var t=s.short_name,u=o.custom_nickname;if(u){var v=c("MercuryIDs").getUserIDFromParticipantID(s.id);if(u[v])t=u[v]}if(o.name)n(h._("{senderName} messaged {groupName}",[h.param("senderName",t),h.param("groupName",o.name)]));else if(c("MercuryIDs").isGroupChat(m))n(h._("{name} messaged your group",[h.param("name",t)]));else n(h._("{name} messaged you",[h.param("name",t)]))});else n(h._("New message!"))})})}f.exports={renderDocumentTitle:l}}),null);
__d("MercuryUnseenState",["MercuryFolders","KeyedCallbackManager","LogHistory","MercuryActionType","MercuryDispatcher","MercuryGlobalActionType","MercurySingletonProvider","MercuryThreadIDMap","MercuryThreadInfo","MercuryThreadlistConstants","MessagingTag","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","createObjectFrom","isEmpty"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();var h=c("MercuryThreadlistConstants").MAX_UNSEEN_COUNT,i="unseen_thread_hash",j="unseen_thread_list",k=c("LogHistory").getInstance("mercury_unseen_state");l.getForFBID=function(n){return m.getForFBID(n)};l.get=function(){return m.get()};function l(n){__p&&__p();this.$MercuryUnseenState2=n;this.$MercuryUnseenState7=c("MercuryServerRequests").getForFBID(this.$MercuryUnseenState2);this.$MercuryUnseenState8=c("MercuryThreadIDMap").getForFBID(this.$MercuryUnseenState2);this.$MercuryUnseenState10=c("MercuryThreads").getForFBID(this.$MercuryUnseenState2);this.$MercuryUnseenState9=c("MercuryThreadInformer").getForFBID(this.$MercuryUnseenState2);this.$MercuryUnseenState1=c("MercuryDispatcher").getForFBID(this.$MercuryUnseenState2);this.$MercuryUnseenState3=0;this.$MercuryUnseenState4=0;this.$MercuryUnseenState5=false;this.$MercuryUnseenState6=false;this.$MercuryUnseenState11=new(c("KeyedCallbackManager"))();this.$MercuryUnseenState1.subscribe("update-unseen",function(o,p){this.$MercuryUnseenState12(p)}.bind(this));this.$MercuryUnseenState1.subscribe("update-thread-ids",function(o,p){this.$MercuryUnseenState13(p)}.bind(this))}l.prototype.getUnseenCount=function(){if(this.exceedsMaxCount()){k.error("unguarded_unseen_count_fetch","{}");return 0}return this.$MercuryUnseenState14()};l.prototype.exceedsMaxCount=function(){return this.$MercuryUnseenState5||this.$MercuryUnseenState14()>h};l.prototype.markAsSeen=function(){var n=this.$MercuryUnseenState14();if(n===null)this.$MercuryUnseenState6=true;else if(n>0||this.$MercuryUnseenState5){this.$MercuryUnseenState7.markSeen();this.$MercuryUnseenState15(this.$MercuryUnseenState7.getLastActionTimestamp(),[])}};l.prototype.$MercuryUnseenState16=function(n,o){var p;this.$MercuryUnseenState17((p={},p[n]=0,p),o)};l.prototype.$MercuryUnseenState18=function(n){this.$MercuryUnseenState11.setResource(i,n);this.$MercuryUnseenState11.setResource(j,Object.keys(n))};l.prototype.$MercuryUnseenState19=function(n){var o=this.$MercuryUnseenState11.executeOrEnqueue(i,n),p=this.$MercuryUnseenState11.getUnavailableResources(o);if(p.length)this.$MercuryUnseenState7.fetchUnseenThreadIDs()};l.prototype.$MercuryUnseenState20=function(){return this.$MercuryUnseenState11.getResource(i)};l.prototype.$MercuryUnseenState14=function(){var n=this.$MercuryUnseenState11.getResource(j);if(n)return n.length;else return this.$MercuryUnseenState3};l.prototype.$MercuryUnseenState12=function(n){__p&&__p();var o,p=this,q=this.$MercuryUnseenState21(n);if(n.unseen_thread_fbids)n.unseen_thread_fbids.forEach(function(r){if(r.folder!=c("MessagingTag").INBOX)return;var s=(r.thread_fbids||[]).concat(r.other_user_fbids||[]),t=this.$MercuryUnseenState22(s),u=q.seen_timestamp?q.seen_timestamp:this.$MercuryUnseenState4;this.$MercuryUnseenState15(u,t);if(q.unseen_count>h)this.$MercuryUnseenState5=true}.bind(this));else if(q.seen_timestamp!==undefined){this.$MercuryUnseenState4=q.seen_timestamp;if(q.unseen_count>h){this.$MercuryUnseenState5=true;this.$MercuryUnseenState18({})}else{this.$MercuryUnseenState3=q.unseen_count;if(this.$MercuryUnseenState3===0)this.$MercuryUnseenState18({})}}else{var o=function(){__p&&__p();var r;(n.global_actions||[]).forEach(function(x){if(x.action_type===c("MercuryGlobalActionType").MARK_ALL_SEEN)this.$MercuryUnseenState15(x.timestamp,[])}.bind(p));if(p.$MercuryUnseenState5)return{v:void 0};var s=n.actions;if(!s||!s.length)return{v:void 0};var t={},u={},v=function v(w){__p&&__p();var x=s[w],y=x.action_type,z=x.other_user_fbid?x.other_user_fbid:x.thread_fbid,A=x.thread_id?x.thread_id:z;if(y===c("MercuryActionType").MARK_THREAD_SEEN){p.$MercuryUnseenState16(A,x.persistent);return"continue"}if(!p.$MercuryUnseenState23(x))return"continue";if(y===c("MercuryActionType").USER_GENERATED_MESSAGE||y===c("MercuryActionType").LOG_MESSAGE){var B=t[A]?x.timestamp>t[A]:false,C=B||!t[A];if(x.is_unread&&C)p.$MercuryUnseenState10.getThreadMeta(A,function(D){if(!c("MercuryThreadInfo").isMuted(D)&&!(D&&D.last_read_timestamp>=x.timestamp))t[A]=x.timestamp})}else if(y===c("MercuryActionType").CHANGE_READ_STATUS&&x.mark_as_read)u[A]=x.timestamp};for(var w=0;w<s.length;w++){var r=v(w);if(r==="continue")continue}p.$MercuryUnseenState24(t);p.$MercuryUnseenState17(u)}();if(typeof o==="object")return o.v}if(this.$MercuryUnseenState6){this.$MercuryUnseenState6=false;this.markAsSeen()}};l.prototype.$MercuryUnseenState15=function(n,o){__p&&__p();var p=this.$MercuryUnseenState20();if(p===undefined||n>this.$MercuryUnseenState4||this.$MercuryUnseenState5){this.$MercuryUnseenState4=n;o=o||[];if(o.length<=h)this.$MercuryUnseenState5=false;var q={},r=this.$MercuryUnseenState20();for(var s in r)if(r[s]!==true){var t=r[s];if(this.$MercuryUnseenState25(t))q[s]=t}var u=Object.assign(c("createObjectFrom")(o,true),q);this.$MercuryUnseenState18(u);this.$MercuryUnseenState9.updatedUnseenState()}};l.prototype.$MercuryUnseenState24=function(n){__p&&__p();if(this.$MercuryUnseenState5)return;var o={},p=false;for(var q in n){var r=n[q];if(this.$MercuryUnseenState25(r)){o[q]=r;p=true}}if(!p)return;this.$MercuryUnseenState19(function(s){for(var t in o){var u=o[t];if(!s[t]&&this.$MercuryUnseenState25(u))s[t]=o[t]}this.$MercuryUnseenState18(s);this.$MercuryUnseenState9.updatedUnseenState()}.bind(this))};l.prototype.$MercuryUnseenState17=function(n,o){__p&&__p();if(!c("isEmpty")(n))this.$MercuryUnseenState19(function(p){__p&&__p();var q=false;for(var r in n){var s=n[r],t=s>=p[r];if(p[r]&&(!s||t)){delete p[r];q=true}}if(q){this.$MercuryUnseenState18(p);this.$MercuryUnseenState9.updatedUnseenState();if(o&&this.$MercuryUnseenState14()===0)this.$MercuryUnseenState7.markSeen()}}.bind(this))};l.prototype.$MercuryUnseenState25=function(n){return n>this.$MercuryUnseenState4};l.prototype.$MercuryUnseenState22=function(n){return n.map(this.$MercuryUnseenState8.convertThreadIDIfAvailable,this.$MercuryUnseenState8)};l.prototype.$MercuryUnseenState13=function(n){__p&&__p();var o=this.$MercuryUnseenState20();if(!o)return;for(var p in n){var q=n[p];if(o[p]){o[q]=o[p];delete o[p]}}this.$MercuryUnseenState18(o)};l.prototype.$MercuryUnseenState23=function(n){var o=n.thread_id?this.$MercuryUnseenState10.getThreadMetaNow(n.thread_id):null,p=o?c("MercuryFolders").getFromMeta(o):n.folder;return p===c("MessagingTag").INBOX||p===undefined};l.prototype.$MercuryUnseenState21=function(n){var o=n.message_counts||[];for(var p=0;p<o.length;p++)if(o[p].folder===c("MessagingTag").INBOX)return o[p];return{}};var m=new(c("MercurySingletonProvider"))(l);f.exports=l}),null);
__d("MessengerDesktopNotificationPermissions",[],(function a(b,c,d,e,f,g){var h=Object.freeze({DEFAULT:"default",DENIED:"denied",GRANTED:"granted"});f.exports=h}),null);
__d("MessengerDesktopNotifications",["Map","MessengerDesktopNotificationPermissions","Run","UserAgent"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();var h=5e3,i=new(c("Map"))();function j(){i.forEach(function(l,m,n){l.close&&l.close()})}var k={_closeTimer:null,isSupported:function l(){return!!window.Notification},checkPermission:function l(){if(window.Notification)return window.Notification.permission},hasDefaultSound:function l(){return c("UserAgent").isBrowser("FireFox")&&c("UserAgent").isPlatform("Mac OS X")},isDenied:function l(){return this.checkPermission()===c("MessengerDesktopNotificationPermissions").DENIED},isGranted:function l(){return this.checkPermission()===c("MessengerDesktopNotificationPermissions").GRANTED},requestPermission:function l(m){if(window.Notification)window.Notification.requestPermission(m)},showNotification:function l(m){__p&&__p();if(this.isGranted()){var n=window.Notification?new window.Notification(m.title,{body:m.body,icon:m.icon,tag:m.tag}):{};i.set(m.tag,n);n.onclick=m.onClick;n.onclose=function(){i["delete"](m.tag)};this._closeTimer=setTimeout(function(){n.close()},m.closeTime||h);return n}else return null}};c("Run").onUnload(j);f.exports=k}),null);
__d("XMessengerDotComSettingsEditController",["XController"],(function a(b,c,d,e,f,g){f.exports=c("XController").create("/settings/edit/",{})}),null);
__d("MessengerSettingsActions",["AsyncRequest","CurrentEnvironment","MessengerDispatcher","MessengerDesktopNotifications","MessengerDesktopNotificationPermissions","MessengerURIConstants","XMessengerDotComSettingsEditController","keyMirror"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();var h=c("keyMirror")({CHANGE_SETTINGS:null,CHANGE_DESKTOP_NOTIFS:null}),i={Types:h,changeSettings:function j(k){var l=c("XMessengerDotComSettingsEditController").getURIBuilder().getURI();if(c("CurrentEnvironment").facebookdotcom)l.setPath(c("MessengerURIConstants").FACEBOOK_PREFIX+l.getPath());new(c("AsyncRequest"))().setData({settings:k}).setURI(l).send();c("MessengerDispatcher").dispatch({type:h.CHANGE_SETTINGS,newSettings:k})},changeDesktopNotifs:function j(k,l){if(k&&!c("MessengerDesktopNotifications").isGranted())c("MessengerDesktopNotifications").requestPermission(function(m){if(m!==c("MessengerDesktopNotificationPermissions").GRANTED){if(c("MessengerDesktopNotifications").checkPermission()===c("MessengerDesktopNotificationPermissions").DENIED)l&&l();return}c("MessengerDispatcher").dispatch({type:h.CHANGE_DESKTOP_NOTIFS,desktopNotifsEnabled:k})});else c("MessengerDispatcher").dispatch({type:h.CHANGE_DESKTOP_NOTIFS,desktopNotifsEnabled:k})}};f.exports=i}),null);
__d("MessengerSettingsStore",["CacheStorage","MessengerSettingsActions","MessengerStore","MessengerDotComSettingsInitialData"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();var h,i,j=new(c("CacheStorage"))("localstorage"),k="desktopNotifsEnabled";h=babelHelpers.inherits(l,c("MessengerStore"));i=h&&h.prototype;function l(){i.constructor.call(this);this.$MessengerSettingsStore1=babelHelpers["extends"]({},c("MessengerDotComSettingsInitialData"),{desktopNotifsEnabled:this.$MessengerSettingsStore2()})}l.prototype.getSettings=function(){return this.$MessengerSettingsStore1};l.prototype.$MessengerSettingsStore2=function(){return j.get(k,false)};l.prototype.$MessengerSettingsStore3=function(m){j.set(k,m)};l.prototype.__onDispatch=function(m){switch(m.type){case c("MessengerSettingsActions").Types.CHANGE_SETTINGS:this.$MessengerSettingsStore1=babelHelpers["extends"]({},this.$MessengerSettingsStore1,m.newSettings);this.emitChange();break;case c("MessengerSettingsActions").Types.CHANGE_DESKTOP_NOTIFS:this.$MessengerSettingsStore1=babelHelpers["extends"]({},this.$MessengerSettingsStore1,{desktopNotifsEnabled:m.desktopNotifsEnabled});this.$MessengerSettingsStore3(m.desktopNotifsEnabled);this.emitChange();break}};f.exports=new l()}),null);
__d("SoundSynchronizer",["SoundPlayer","WebStorage","createArrayFromMixed"],(function a(b,c,d,e,f,g){__p&&__p();var h="fb_sounds_playing3";function i(){__p&&__p();var m=c("WebStorage").getLocalStorage();if(m)try{var n=m[h];if(n){n=JSON.parse(n);if(Array.isArray(n))return n}}catch(o){}return[]}function j(m){var n=c("WebStorage").getLocalStorage();if(n){var o=i();o.push(m);while(o.length>5)o.shift();try{n[h]=JSON.stringify(o)}catch(p){}}}function k(m){return i().some(function(n){return n===m})}var l={play:function m(n,o,p){n=c("createArrayFromMixed")(n);o=o||n[0]+Math.floor(Date.now()/1e3);if(k(o))return;c("SoundPlayer").play(n,{loop:!!p});j(o)},isSupported:function m(){return!!c("WebStorage").getLocalStorage()}};f.exports=l}),null);
__d("SoundRPC",["Event","FBJSON","SoundSynchronizer"],(function a(b,c,d,e,f,g){__p&&__p();function h(j,k,l){c("SoundSynchronizer").play(j,k,l)}var i={playLocal:h,playRemote:function j(k,l,m,n){var o={name:"SoundRPC",data:{paths:l,sync:m,loop:n}};k.postMessage(c("FBJSON").stringify(o),"*")},supportsRPC:function j(){return!!window.postMessage},_listen:function j(){c("Event").listen(window,"message",function(k){if(!/\.facebook.com$/.test(k.origin))return;var l={};try{l=c("FBJSON").parse(k.data)}catch(m){}if(l.name==="SoundRPC")h(l.data.paths,l.data.sync,l.data.loop)})}};f.exports=i}),null);
__d("Sound",["SoundInitialData","SoundPlayer","SoundRPC","SoundSynchronizer","URI","UserAgent_DEPRECATED","Visibility","isFacebookURI"],(function a(b,c,d,e,f,g){__p&&__p();var h=null,i=false,j={init:function n(o){},play:function n(o,p,q){if(h)c("SoundRPC").playRemote(h.contentWindow,o,p,false);else c("SoundRPC").playLocal(o,p,q);i=true},hasPlayedSoundBefore:function n(){return i},playOnlyIfImmediate:function n(o,p,q){if(!i&&c("Visibility").isHidden())return;this.play(o,p,q)},stop:function n(o){if(!h)c("SoundPlayer").stop(o)}},k=new(c("URI"))(location.href);if(k.getSubdomain()&&k.getSubdomain()!=="www")k.setSubdomain("www");var l=k.getDomain();function m(){if(c("UserAgent_DEPRECATED").ie()<9)return false;if(c("SoundInitialData").RPC_DISABLED)return false;return c("SoundSynchronizer").isSupported()&&c("SoundRPC").supportsRPC()}if(c("isFacebookURI")(k)&&location.host!==l&&m()){h=document.createElement("iframe");h.setAttribute("src","//"+l+"/sound_iframe.php");h.style.display="none";document.body.appendChild(h)}f.exports=j}),null);
__d("MercuryIgnoredBlockedParticipantsRe",["bs_caml_obj","bs_js_boolean","MercuryIDs"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();function h(l,m,n){var o=n.participants.filter(function(p){return+(p!==c("MercuryIDs").getParticipantIDFromUserID(l))});return o.filter(function(p){return+(+m.has(p)!==0)})}function i(l,m,n){return c("bs_js_boolean").to_js_boolean(1-+n.is_canonical&&+(h(l,m,n).length>0))}function j(l,m,n){if(n.is_canonical)return[];else return h(l,m,n)}function k(l,m,n){var o=+n.is_canonical;if(o!==0){var p=n.participants.filter(function(q){return c("bs_caml_obj").caml_notequal(q,c("MercuryIDs").getParticipantIDFromUserID(l))});return c("bs_js_boolean").to_js_boolean(1-+p.every(function(q){return 1-+m.has(q)}))}else return false}g.findIntersection=h;g.isPresentInGroupThread=i;g.participantsInGroupThread=j;g.qualifiesAs=k}),null);
__d("mercurySingletonProviderRe",["bs_curry","CurrentUser"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();function h(i){__p&&__p();var j={},k=function k(m){var n=j[m];if(n!==undefined)return n;else{var o=c("bs_curry")._1(i[0],m);j[m]=o;return o}},l=function l(){return k(c("CurrentUser").getID())};return[k,l]}g.Provider=h}),null);
__d("mercuryBlockedParticipantsRe",["Set","utilsRe","MercuryIDs","bs_js_primitive","MercuryDispatcher","mercurySingletonProviderRe","MercuryIgnoredBlockedParticipantsRe"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();function h(m,n){__p&&__p();var o=n.message_blocked_ids;if(o==null)return 0;else{o.forEach(function(p){if(m.has(p)){+m["delete"](p);return 0}else{m.add(p);return 0}});return 0}}function i(m){__p&&__p();var n=new(c("Set"))(),o=c("MercuryDispatcher").getForFBID(m);o.subscribe("update-blocked-users",function(p,q){__p&&__p();var r=q.actions;if(!(r==null))r.forEach(function(t){return h(n,t)});h(n,q);var s=c("utilsRe").$pipe$unknown(c("bs_js_primitive").null_undefined_to_opt(q.participants),[]);s.forEach(function(t){__p&&__p();var r=c("utilsRe").nullUndefinedBooleanToOptionBool(t.is_messenger_blocked),u=t.fbid;if(r)if(r[0]!==0)if(u==null)return 0;else{n.add(c("MercuryIDs").getParticipantIDFromUserID(u));return 0}else if(u==null)return 0;else{+n["delete"](c("MercuryIDs").getParticipantIDFromUserID(u));return 0}else return 0});return 0});return{findIntersection:function p(q){return c("MercuryIgnoredBlockedParticipantsRe").findIntersection(m,n,q)},isPresentInGroupThread:function p(q){return c("MercuryIgnoredBlockedParticipantsRe").isPresentInGroupThread(m,n,q)},blockedParticipantsInGroupThread:function p(q){return c("MercuryIgnoredBlockedParticipantsRe").participantsInGroupThread(m,n,q)},isMessageBlocked:function p(q){return c("MercuryIgnoredBlockedParticipantsRe").qualifiesAs(m,n,q)},__fbid:m}}var j=c("mercurySingletonProviderRe").Provider([i]),k=j[0],l=j[1];g.getForFBID=k;g.get=l}),null);
__d("MessengerBrowserAlerts",["fbt","DocumentTitle","Event","ImageSourceRequest","ImageSourceType","Map","MercuryAttachmentSnippetRenderer","mercuryBlockedParticipantsRe","MercuryIDs","MercuryLogMessageType","MercuryParticipants","MercuryThreadInfo","MercuryThreadInformer","MercuryThreads","MercuryUnseenState","MessagingTag","MessengerActions","MessengerConfig","MessengerDesktopNotifications","MessengerEnvironment","MessengerFaviconUrls","MessengerSettingsStore","MessengerStateStore","MercuryNotificationRenderer","PhotoResizeModeConst","Sound","UserActivity"],(function a(b,c,d,e,f,g,h){"use strict";__p&&__p();var i=c("mercuryBlockedParticipantsRe").get(),j=8e3,k=80,l=3,m=6e5,n=new(c("Map"))(),o=0,p=null;function q(){n=new(c("Map"))()}function r(u){if(c("MessengerSettingsStore").getSettings().sound_enabled)c("Sound").play([c("MessengerConfig")["sound.notif_ogg_url"],c("MessengerConfig")["sound.notif_mp3_url"]],u,false)}function s(u,v,w){__p&&__p();if(!u.snippet_sender)return;var x=n.get(u.thread_id)||0;if(x>=l)return;n.set(u.thread_id,x+1);c("MercuryParticipants").get(u.snippet_sender,function(y){__p&&__p();var z=u.snippet,A=u.custom_nickname&&u.custom_nickname[c("MercuryIDs").getUserIDFromParticipantID(y.id)],B=A?A:y.short_name;if(!z&&u.snippet_attachments&&u.snippet_attachments.length>0)z=c("MercuryAttachmentSnippetRenderer").renderAttachmentSnippetText(c("MercuryAttachmentSnippetRenderer").getAttachmentSnippetType(u.snippet_attachments),false,B,u.snippet_attachments);var C=A?A:y.name;if(!u.is_canonical)C=u.name?h._("{sender's name} to {group name}",[h.param("sender's name",B),h.param("group name",u.name)]):h._("{sender's name} to your group",[h.param("sender's name",B)]);c("MessengerDesktopNotifications").showNotification({title:C,body:z,icon:u.image_src||v||y.big_image_src||y.image_src,closeTime:null,onClick:function D(){window.focus();c("MessengerActions").selectThread(u.thread_id)},tag:w.message_id});if(!c("MessengerDesktopNotifications").hasDefaultSound())r(w.timestamp)})}var t={init:function u(v){__p&&__p();this._viewer=v;this._threadInformer=c("MercuryThreadInformer").getForFBID(this._viewer);this._threads=c("MercuryThreads").getForFBID(this._viewer);this._unseenState=c("MercuryUnseenState").getForFBID(this._viewer);this._highResImageMap=new(c("Map"))();c("Event").listen(window,"focus",function(){q();clearInterval(o)});c("Event").listen(window,"blur",function(){o=setInterval(q,m)});this._threadInformer.subscribe("messages-received",function(w,x){for(var y in x)x[y].forEach(function(z){this.handleMessageReceived(z)}.bind(this))}.bind(this));this._threadInformer.subscribe("unseen-updated",this._handleUnseenUpdated.bind(this))},handleMessageReceived:function u(v){__p&&__p();if(v.author===this._viewer||!v.is_unread||v.thread_id===c("MessengerStateStore").getState().activeThreadID&&c("UserActivity").isOnTab()||v.folder!=c("MessagingTag").INBOX&&v.folder!=c("MessagingTag").ARCHIVED)return;this._threads.getThreadMeta(v.thread_id,function(w){__p&&__p();if(c("MercuryThreadInfo").isMuted(w))if(!c("MercuryThreadInfo").areMentionsMuted(w)){if(!v.profile_ranges||!v.profile_ranges.some||!v.profile_ranges.some(function(x){return x.id===this._viewer}.bind(this)))return}else return;if(i.isPresentInGroupThread(w))return;if(c("MessengerSettingsStore").getSettings().desktopNotifsEnabled&&!c("UserActivity").isOnTab())this._attemptDesktopNotification(w,v);else if(v.log_message_type!==c("MercuryLogMessageType").UNSUBSCRIBE)r(v.timestamp);if(!c("UserActivity").isOnTab()&&this._unseenState.getUnseenCount()>0)c("MercuryNotificationRenderer").renderDocumentTitle(v.thread_id,function(x){if(!p)p=c("DocumentTitle").blink(x)})}.bind(this))},showRTCNotification:function u(v,w){__p&&__p();if(c("UserActivity").isOnTab()){w(null);return}var x=v.peerID;if(!this._highResImageMap.has(x)){var y=function(z,A){this._highResImageMap.set(x.toString(),A.uri);this._displayRTCDesktopNotification(A.uri,v,w)}.bind(this);new(c("ImageSourceRequest"))().setFBID(x).setType(c("ImageSourceType").PROFILE_PICTURE).setDimensions(k,k).setResizeMode(c("PhotoResizeModeConst").COVER).setCallback(y.bind(null,x)).send()}else this._displayRTCDesktopNotification(this._highResImageMap.get(x),v,w)},_updateFavicon:function u(v){var w=document.querySelector('link[rel*=icon][href*=".ico"]');if(!w)return;if(v===0)w.href=c("MessengerFaviconUrls")["default"];else w.href=c("MessengerFaviconUrls").unread},_displayRTCDesktopNotification:function u(v,w,x){__p&&__p();var y=c("MercuryIDs").getParticipantIDFromUserID(w.peerID),z=null;c("MercuryParticipants").get(y,function(A){__p&&__p();var B=void 0;if(w.isVideoCall)if(w.isGroupCall)B=h._("Incoming Group Video Chat");else B=h._("Incoming Video Call");else if(w.isGroupCall)B=h._("Incoming Group Call");else B=h._("Incoming Audio Call");var C=h._("{caller} is calling you. Click to answer.",[h.param("caller",A.short_name)]);z=c("MessengerDesktopNotifications").showNotification({title:B,body:C,icon:v,closeTime:j,onClick:function D(){window.focus();w.onNotificationClicked()}});x(z)})},_handleUnseenUpdated:function u(){__p&&__p();var v=this._unseenState.getUnseenCount();if(c("UserActivity").isOnTab()&&c("UserActivity").isActive()&&v>0){this._updateFavicon(0);this._unseenState.markAsSeen();return}var w=c("DocumentTitle").get(),x=v?"("+v+") "+w:w;c("DocumentTitle").set(x,true);this._updateFavicon(v);if(p&&v===0){p.stop();p=null}if(!this._focusToken&&v>0)this._focusToken=c("UserActivity").subscribe(function(){if(c("UserActivity").isOnTab()){this._focusToken&&this._focusToken.unsubscribe();this._focusToken=null;this._unseenState.markAsSeen()}}.bind(this))},_attemptDesktopNotification:function u(v,w){if(!v.snippet_sender)return;if(!this._highResImageMap.has(v.snippet_sender)){var x=function(y,z){this._highResImageMap.set(v.snippet_sender,z.uri);s(v,z.uri,w)}.bind(this);new(c("ImageSourceRequest"))().setFBID(c("MercuryIDs").getUserIDFromParticipantID(v.snippet_sender)).setType(c("ImageSourceType").PROFILE_PICTURE).setDimensions(k,k).setResizeMode(c("PhotoResizeModeConst").COVER).setCallback(x.bind(null,v.snippet_sender)).send()}else s(v,this._highResImageMap.get(v.snippet_sender),w)}};f.exports=t}),null);
__d("MessengerRTCIncomingDialog.react",["cx","fbt","ImageBlock.react","MercuryIDs","MercuryParticipants","messengerDialogsRe","messengerContactImageReact","MessengerDialog.react","messengerDialogBodyReact","MessengerDialogButton.react","MessengerDialogFooter.react","MessengerDialogHeader.react","MessengerSpinner.react","React","StoreAndPropBasedStateMixin"],(function a(b,c,d,e,f,g,h,i){"use strict";__p&&__p();var j=c("messengerContactImageReact").jsComponent,k=c("messengerDialogBodyReact").jsComponent,l=c("React").PropTypes,m=50,n=c("React").createClass({displayName:"MessengerRTCIncomingDialog",mixins:[c("StoreAndPropBasedStateMixin")(c("MercuryParticipants"))],propTypes:{callerID:l.string.isRequired,onAccept:l.func.isRequired,onDecline:l.func.isRequired,isVideoCall:l.bool.isRequired},statics:{calculateState:function o(p){return{callerParticipant:c("MercuryParticipants").getOrFetch(c("MercuryIDs").getParticipantIDFromUserID(p.callerID))}}},render:function o(){return c("React").createElement(c("MessengerDialog.react"),{layerHideOnBlur:false,shown:true,onToggle:this._handleToggle,width:400},c("React").createElement(c("MessengerDialogHeader.react"),null,this._dialogTitle()),c("React").createElement(k,null,this._renderDialogBody()),c("React").createElement(c("MessengerDialogFooter.react"),null,c("React").createElement(c("MessengerDialogButton.react"),{label:i._("Decline"),onClick:this._handleDecline,type:"secondary"}),c("React").createElement(c("MessengerDialogButton.react"),{label:i._("Accept"),onClick:this._handleAccept,type:"primary"})))},_dialogTitle:function o(){if(this.props.isVideoCall)return i._("Incoming Video Call");return i._("Incoming Audio Call")},_renderDialogBody:function o(){var p=this.state.callerParticipant;if(!p)return c("React").createElement(c("MessengerSpinner.react"),null);return c("React").createElement(c("ImageBlock.react"),null,c("React").createElement(j,{isMessengerUser:p.is_messenger_user,size:m,src:p.big_image_src||p.image_src}),c("React").createElement("div",{className:"_2n1r"},c("React").createElement("div",{className:"_2n1s"},i._("{caller name} is calling you.",[i.param("caller name",p.name)])),c("React").createElement("div",{className:"_2n1t"},i._("The call will start as soon as you answer."))))},_handleDecline:function o(event){event.preventDefault();c("messengerDialogsRe").removeAllDialogs();this.props.onDecline()},_handleAccept:function o(event){event.preventDefault();c("messengerDialogsRe").removeAllDialogs();this.props.onAccept()},_handleToggle:function o(p){if(!p){c("messengerDialogsRe").removeAllDialogs();this.props.onDecline()}}});f.exports=n}),null);
__d("FBRTCSoundController",["RTCConfig","Sound"],(function a(b,c,d,e,f,g){var h=[c("RTCConfig").ringtone_mp3_url,c("RTCConfig").ringtone_ogg_url],i={playIncomingRingtone:function j(k,l,m){var n=["incoming_ringtone",k.toString(),l.toString()].join("_");c("Sound").play(h,n,m)},stopIncomingRingtone:function j(){c("Sound").stop(h)}};f.exports=i}),null);
__d("MessengerRTCIncomingDialogController",["FBRTCConstants","FBRTCSoundController","MessengerRTCIncomingDialog.react","messengerDialogsRe","MessengerBrowserAlerts","React","RTCConfig","VideoCallTypedLogger","mixInEventEmitter","setTimeoutAcrossTransitions"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();var h=7e4;function i(j,k){this.$MessengerRTCIncomingDialogController1=j;this.$MessengerRTCIncomingDialogController2=k;this.$MessengerRTCIncomingDialogController3=null;this.$MessengerRTCIncomingDialogController4=null;this.$MessengerRTCIncomingDialogController5=false}i.prototype.showIncomingDialog=function(j){this.timeout=c("setTimeoutAcrossTransitions")(this.$MessengerRTCIncomingDialogController6.bind(this),h);var k=j===c("FBRTCConstants").IncomingCallDialogTypes.VIDEO;c("FBRTCSoundController").playIncomingRingtone(this.$MessengerRTCIncomingDialogController2,this.$MessengerRTCIncomingDialogController1,true);c("messengerDialogsRe").showDialog(function(){return c("React").createElement(c("MessengerRTCIncomingDialog.react"),{callerID:this.$MessengerRTCIncomingDialogController1.toString(),onAccept:this.$MessengerRTCIncomingDialogController7.bind(this),onDecline:this.$MessengerRTCIncomingDialogController8.bind(this),isVideoCall:k})}.bind(this));if(c("RTCConfig").BrowserNotificationGK)this.$MessengerRTCIncomingDialogController9(k)};i.prototype.$MessengerRTCIncomingDialogController9=function(j){var k={peerID:this.$MessengerRTCIncomingDialogController1,onNotificationClicked:this.$MessengerRTCIncomingDialogController7.bind(this),isVideoCall:j};c("MessengerBrowserAlerts").showRTCNotification(k,function(l){this.$MessengerRTCIncomingDialogController4=l;if(this.$MessengerRTCIncomingDialogController5)this.$MessengerRTCIncomingDialogController10()}.bind(this))};i.prototype.cancel=function(){if(this.timeout)clearTimeout(this.timeout);c("messengerDialogsRe").removeDialog();c("FBRTCSoundController").stopIncomingRingtone();if(this.$MessengerRTCIncomingDialogController4)this.$MessengerRTCIncomingDialogController10();this.$MessengerRTCIncomingDialogController5=true};i.prototype.isForPeer=function(j){return this.$MessengerRTCIncomingDialogController1===j};i.prototype.isForCall=function(j){return this.$MessengerRTCIncomingDialogController2===j};i.prototype.isForPeerAndCall=function(j,k){return this.$MessengerRTCIncomingDialogController1===j&&this.$MessengerRTCIncomingDialogController2===k};i.prototype.$MessengerRTCIncomingDialogController7=function(){this.cancel();new(c("VideoCallTypedLogger"))().setEvent("accept_call_click").log();this.emit("answerCall",null)};i.prototype.$MessengerRTCIncomingDialogController8=function(){this.cancel();this.emit("ignoreCall")};i.prototype.$MessengerRTCIncomingDialogController6=function(){this.cancel();this.emit("timeout")};i.prototype.$MessengerRTCIncomingDialogController10=function(){this.$MessengerRTCIncomingDialogController4.close();this.$MessengerRTCIncomingDialogController4=null};c("mixInEventEmitter")(i,{answerCall:true,ignoreCall:true,timeout:true});f.exports=i}),null);
__d("MessengerRTCMissedCallDialog.react",["cx","fbt","ImageBlock.react","MercuryIDs","MercuryParticipants","messengerDialogsRe","messengerContactImageReact","MessengerDialog.react","messengerDialogBodyReact","MessengerDialogButton.react","MessengerDialogFooter.react","MessengerDialogHeader.react","MessengerDialogTitle.react","MessengerSpinner.react","React","MNRTCCallabilityStore","StoreAndPropBasedStateMixin","Timestamp.react"],(function a(b,c,d,e,f,g,h,i){"use strict";__p&&__p();var j=c("messengerContactImageReact").jsComponent,k=c("messengerDialogBodyReact").jsComponent,l=c("React").PropTypes,m=50,n=c("React").createClass({displayName:"MessengerRTCMissedCallDialog",mixins:[c("StoreAndPropBasedStateMixin")(c("MercuryParticipants"),c("MNRTCCallabilityStore"))],propTypes:{peerID:l.string.isRequired,timeMissed:l.number.isRequired},statics:{calculateState:function o(p){var q=p.peerID;return{calleeParticipant:c("MercuryParticipants").getOrFetch(c("MercuryIDs").getParticipantIDFromUserID(q))}}},render:function o(){return c("React").createElement(c("MessengerDialog.react"),{layerHideOnBlur:true,onToggle:this._handleToggle,shown:true,width:400},c("React").createElement(c("MessengerDialogHeader.react"),null,c("React").createElement(c("MessengerDialogTitle.react"),null,i._("Missed Call"))),c("React").createElement(k,null,this._renderBody()),c("React").createElement(c("MessengerDialogFooter.react"),null,c("React").createElement(c("MessengerDialogButton.react"),{label:i._("Close"),onClick:this._handleClose,type:"secondary"}),c("React").createElement(c("MessengerDialogButton.react"),{label:i._("Call Back"),onClick:this._handleCallBack,type:"primary"})))},_renderBody:function o(){var p=this.state.calleeParticipant;if(!p)return c("React").createElement(c("MessengerSpinner.react"),null);return c("React").createElement(c("ImageBlock.react"),null,c("React").createElement(j,{isMessengerUser:p.is_messenger_user,size:m,src:p.big_image_src||p.image_src}),c("React").createElement("div",{className:"_2r2t"},c("React").createElement("div",{className:"_2r2u"},i._("You missed a call from {caller name}",[i.param("caller name",p.name)])),c("React").createElement("div",{className:"_2r2v"},c("React").createElement(c("Timestamp.react"),{time:this.props.timeMissed,autoUpdate:true}))))},_handleCallBack:function o(event){event.preventDefault();c("messengerDialogsRe").removeDialog(n);var p=this.state.calleeParticipant;e(["FBRTCCore"],function(q){q.startOutgoingCall(p.fbid,"messenger_dot_com",false)})},_handleClose:function o(event){event.preventDefault();c("messengerDialogsRe").removeDialog(n)},_handleToggle:function o(p){if(!p)c("messengerDialogsRe").removeDialog(n)}});f.exports=n}),null);
__d("MessengerRTCMissedCallDialogController",["messengerDialogsRe","MessengerRTCMissedCallDialog.react","React"],(function a(b,c,d,e,f,g){"use strict";var h={onCallMissed:function i(j){this._missedCallPeerID=j},showDialog:function i(){if(!this._missedCallPeerID)return;c("messengerDialogsRe").showDialog(function(){return c("React").createElement(c("MessengerRTCMissedCallDialog.react"),{peerID:this._missedCallPeerID.toString(),timeMissed:Date.now()})}.bind(this))},hideDialog:c("messengerDialogsRe").removeAllDialogs};f.exports=h}),null);
__d("MessengerRTCUnsupportedBrowserDialog.react",["cx","fbt","CurrentUser","FBRTCConfig","Link.react","messengerDialogsRe","MessengerDialog.react","messengerDialogBodyReact","MessengerDialogButton.react","MessengerDialogFooter.react","MessengerDialogHeader.react","React","UserAgent"],(function a(b,c,d,e,f,g,h,i){"use strict";__p&&__p();var j,k,l=c("messengerDialogBodyReact").jsComponent;j=babelHelpers.inherits(m,c("React").Component);k=j&&j.prototype;m.prototype.render=function(){return c("React").createElement(c("MessengerDialog.react"),{onToggle:this.$MessengerRTCUnsupportedBrowserDialog1},c("React").createElement(c("MessengerDialogHeader.react"),null,i._("Switch Browsers to Make Calls")),c("React").createElement(l,null,this.$MessengerRTCUnsupportedBrowserDialog2()),c("React").createElement(c("MessengerDialogFooter.react"),null,c("React").createElement(c("MessengerDialogButton.react"),{className:"_30vt",label:i._("Learn More"),onClick:this.$MessengerRTCUnsupportedBrowserDialog3,type:"secondary",href:c("FBRTCConfig").unsupportedBrowserUrl(),target:"_blank"}),c("React").createElement(c("MessengerDialogButton.react"),{label:i._("OK"),onClick:this.$MessengerRTCUnsupportedBrowserDialog4,type:"primary"})))};m.prototype.$MessengerRTCUnsupportedBrowserDialog2=function(){if(c("CurrentUser").isWorkUser())return i._("Unfortunately, {browser name, i.e. Internet Explorer or Safari} doesn't support our new video calling feature yet. To make a call, open Workplace Chat in {link to install chrome} or {link to install firefox} .",[i.param("browser name, i.e. Internet Explorer or Safari",this.$MessengerRTCUnsupportedBrowserDialog5()),i.param("link to install chrome",this.$MessengerRTCUnsupportedBrowserDialog6()),i.param("link to install firefox",this.$MessengerRTCUnsupportedBrowserDialog7())]);else return i._("Unfortunately, {browser name, i.e. Internet Explorer or Safari} doesn't support our new video calling feature yet. To make a call, open Messenger in {link to install chrome} or {link to install firefox} .",[i.param("browser name, i.e. Internet Explorer or Safari",this.$MessengerRTCUnsupportedBrowserDialog5()),i.param("link to install chrome",this.$MessengerRTCUnsupportedBrowserDialog6()),i.param("link to install firefox",this.$MessengerRTCUnsupportedBrowserDialog7())])};m.prototype.$MessengerRTCUnsupportedBrowserDialog6=function(){return c("React").createElement(c("Link.react"),{onClick:this.$MessengerRTCUnsupportedBrowserDialog4,href:"https://www.google.com/chrome/index.html",target:"_blank"},"Google Chrome")};m.prototype.$MessengerRTCUnsupportedBrowserDialog7=function(){return c("React").createElement(c("Link.react"),{onClick:this.$MessengerRTCUnsupportedBrowserDialog4,href:"https://www.mozilla.org/en-US/firefox/new/",target:"_blank"},"Mozilla Firefox")};m.prototype.$MessengerRTCUnsupportedBrowserDialog5=function(){if(c("UserAgent").isBrowser("IE"))return"Internet Explorer";if(c("UserAgent").isBrowser("Safari"))return"Safari";return"your browser"};m.prototype.$MessengerRTCUnsupportedBrowserDialog3=function(){c("messengerDialogsRe").removeAllDialogs()};m.prototype.$MessengerRTCUnsupportedBrowserDialog4=function(){c("messengerDialogsRe").removeAllDialogs()};m.prototype.$MessengerRTCUnsupportedBrowserDialog1=function(n){if(!n)c("messengerDialogsRe").removeAllDialogs()};function m(){j.apply(this,arguments)}f.exports=m}),null);
__d("MessengerRTCUnsupportedBrowserDialogController",["messengerDialogsRe","MessengerRTCUnsupportedBrowserDialog.react","React"],(function a(b,c,d,e,f,g){"use strict";var h={_dialog:null,showForIncomingCall:function i(j,k){c("messengerDialogsRe").showDialog(function(){return c("React").createElement(c("MessengerRTCUnsupportedBrowserDialog.react"),null)})},dismiss:c("messengerDialogsRe").removeAllDialogs};f.exports=h}),null);
__d("FBRTCStore",["FBRTCDispatcher","FluxStore"],(function a(b,c,d,e,f,g){"use strict";var h,i;h=babelHelpers.inherits(j,c("FluxStore"));i=h&&h.prototype;function j(){i.constructor.call(this,c("FBRTCDispatcher"))}j.prototype.__emitChange=function(){this.__emitter.emit(this.__changeEvent)};f.exports=j}),null);
__d("FBRTCCallBlockingStore",["Arbiter","AsyncRequest","ChannelConstants","FBRTCDispatcher","FBRTCStore","VideoCallTypedLogger","setTimeoutAcrossTransitions"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();var h,i,j=false,k=0,l=null,m="call_block_setting_changed";h=babelHelpers.inherits(n,c("FBRTCStore"));i=h&&h.prototype;n.prototype.init=function(o){this.$FBRTCCallBlockingStore1(o);c("Arbiter").subscribe(c("ChannelConstants").getArbiterType("videocall_block_setting"),this.$FBRTCCallBlockingStore2.bind(this))};n.prototype.__onDispatch=function(o){if(o.type!==m)return;this.$FBRTCCallBlockingStore1(o.data)};n.prototype.$FBRTCCallBlockingStore1=function(o){__p&&__p();switch(o){case 0:j=false;this.$FBRTCCallBlockingStore3();break;case-1:j=true;this.$FBRTCCallBlockingStore3();break;default:j=true;this.$FBRTCCallBlockingStore4(o)}this.__emitChange()};n.prototype.$FBRTCCallBlockingStore4=function(o){if(l===null)l=c("setTimeoutAcrossTransitions")(this.turnOnVideoCalling.bind(this),o*1e3)};n.prototype.getBlockingStatus=function(){return j};n.prototype.turnOnVideoCalling=function(){new(c("AsyncRequest"))("/ajax/chat/settings.php").setHandler(this.$FBRTCCallBlockingStore5.bind(this)).setData({call_blocked_until:0}).send()};n.prototype.turnOffVideoCalling=function(o){k=o;new(c("AsyncRequest"))("/ajax/chat/settings.php").setHandler(this.$FBRTCCallBlockingStore6.bind(this)).setData({call_blocked_until:o}).send()};n.prototype.$FBRTCCallBlockingStore3=function(){if(l){clearTimeout(l);l=null}};n.prototype.$FBRTCCallBlockingStore5=function(){c("FBRTCDispatcher").dispatch({type:m,data:0});new(c("VideoCallTypedLogger"))().setEvent(m).setMessage("enable").log()};n.prototype.$FBRTCCallBlockingStore6=function(){c("FBRTCDispatcher").dispatch({type:m,data:k});new(c("VideoCallTypedLogger"))().setEvent(m).setMessage("disable_"+k).log()};n.prototype.$FBRTCCallBlockingStore2=function(o,p){c("FBRTCDispatcher").dispatch({type:m,data:p.obj.value})};function n(){h.apply(this,arguments)}f.exports=new n()}),null);
__d("QE",["Banzai","Cache"],(function a(b,c,d,e,f,g){__p&&__p();var h="qe_log_exposure",i=60,j=new(c("Cache"))(),k={logExposure:function l(m,n){var o=n?m+"|"+n:m;if(j.has(o))return;var p={signal:true},q={name:m,id:null};if(n)q.id=n;c("Banzai").post(h,q,p);j.set(o,true,1,i)}};f.exports=k}),null);
__d("FBRTCExperiment",["FBRTCExperimentsConfig","QE"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();h.gen=function(i){var j={params:{},in_experiment:false,auto_exposure:false},k=c("FBRTCExperimentsConfig")[i]||j,l=new h(i,k.params,k.in_experiment);if(k.auto_exposure)l.logExposure(i);return l};function h(i,j,k){this.$FBRTCExperiment2=i;this.$FBRTCExperiment3=j;this.$FBRTCExperiment1=k}h.prototype.logExposure=function(){if(this.$FBRTCExperiment1)c("QE").logExposure(this.$FBRTCExperiment2)};h.prototype.getParam=function(i,j){if(this.$FBRTCExperiment3[i])return this.$FBRTCExperiment3[i].toString();return j};h.prototype.getInt=function(i,j){if(this.$FBRTCExperiment3[i])return parseInt(this.$FBRTCExperiment3[i],10);return j};h.prototype.getBool=function(i,j){var k=this.$FBRTCExperiment3;if(k[i])return k[i]==="1"||k[i]===1||k[i]==="true";return j};f.exports=h}),null);
__d("FBRTCSdpUtils",["UserAgent"],(function a(b,c,d,e,f,g){__p&&__p();var h="m=video 0",i="m=video 0 NULL/NULL 0",j=["audio","video"].map(function(y){return new RegExp("m="+y+"\\s+\\d+\\s+(\\w+\\/?)+(\\s+\\d+)+")}),k=j[0],l=j[1],m=["http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01","http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time","http://www.webrtc.org/experiments/rtp-hdrext/playout-delay","urn:3gpp:video-orientation","urn:ietf:params:rtp-hdrext:ssrc-audio-level","urn:ietf:params:rtp-hdrext:toffset"],n=function n(y){return y.match(/^a=rtpmap:(\d+)\s/)[1]},o=function o(y,z,A){var B=n(y[z]),C=y[A].split("RTP/SAVPF"),D=C[1].split(/\s+/),E=D.indexOf(B);D.splice(E,1);C[1]=D.join(" ");y[A]=C.join("RTP/SAVPF");y.splice(z,1)},p=function p(y,z,A){__p&&__p();var B=n(y[z]);o(y,z,A);var C=new RegExp("^a=(rtcp-fb|fmtp):"+B+" ");y=y.filter(function(G){return!C.test(G)});var D=new RegExp("^a=fmtp:(\\d+)\\s+apt="+B+"($|;)"),E=y.reduce(function(E,G,H){var I=G.match(D);return I?[].concat(E,[I[1]]):E},[]).join("|"),F=new RegExp("^a=rtpmap:("+E+")\\s+rtx/|^a=fmtp:("+E+")\\s+apt=");return y.filter(function(G){return!F.test(G)})},q={RX_SDP_MEDIA_AUDIO:k,RX_SDP_MEDIA_VIDEO:l,replaceRTPSAVPFProfile:function y(z){var A="UDP/TLS/RTP/SAVPF",B="RTP/SAVPF";while(z.indexOf(A)>=0)z=z.replace(A,B);return z},addIceOptionToSdp:function y(z,A){"use strict";__p&&__p();var B="a=ice-options:",C=z.indexOf(B);if(C>=0)return z.split("\r\n").map(function(J){return J.startsWith(B)?J+" "+A:J}).join("\r\n");var D=B+A,E=z.split("\r\n"),F=false,G=-1;for(var H=0;H<E.length;H++){var I=E[H].slice(0,2);if(I=="s="){F=true;continue}if(F&&I=="a="){G=H;break}}if(G>=0){E.splice(G,0,D);return E.join("\r\n")}return[z,D,"\r\n"].join("")},preferIsac:function y(z){__p&&__p();var A=z.split("\r\n"),B=-1,C=-1,D=-1;for(var E=0;E<A.length;E++){var F=A[E];if(F.match(k))B=E;if(D===-1&&B>-1&&F.match(/^a=rtpmap:/))D=E;if(F.match(/^a=rtpmap:\d+\s+ISAC\/16000/))C=E}if(B===-1||C===-1||D===-1||A[B].indexOf("RTP/SAVPF")===-1)return A.join("\r\n");var G=A[C];o(A,C,B);A.splice(D,0,G);A[B]=A[B].replace("RTP/SAVPF","RTP/SAVPF "+n(G));return A.join("\r\n")},preferCodec:function y(z,A,B){__p&&__p();var C,D=z.split("\r\n"),E=B?l:k,F=D.findIndex(function(G){return E.test(G)});if(F!==-1&&D[F].indexOf("RTP/SAVPF")!==-1)(function(){var G=new RegExp("^a=rtpmap:\\d+\\s+"+A),H=D.findIndex(function(L){return G.test(L)}),I=/^a=rtpmap:/,J=D.findIndex(function(L,M){return M>F&&I.test(L)});if(H!==-1&&J!==-1){var K=D[H];o(D,H,F);D.splice(J,0,K);D[F]=D[F].replace("RTP/SAVPF","RTP/SAVPF "+n(K))}})();return D.join("\r\n")},disableVideo:function y(z){var A=/m=video\s+\S+/;z=z.replace(A,h);if(c("UserAgent").isBrowser("Firefox <= 37"))z=this._makeDisabledVideoReceiveOnly(z);return z},_makeDisabledVideoReceiveOnly:function y(z){if(z.indexOf(h)>-1){var A=z.split(h);A[1]=A[1].replace(/send(recv|only)/,"recvonly");z=A.join(h)}return z},fixMobileIceSdp:function y(z){__p&&__p();z=z.replace(/^a=/,"");z=z.split(/\s+username\s+.+password.+/)[0];var A=z.match(/\s+relay\s+|\s+srflx\s+/),B=z.match(/raddr.+rport.+/);if(A&&!B){A=A[0];var C=z.split(A),D=C[1].match(/^(\d+\.\d+\.\d+\.\d+)\s+(\d+)\s+/),E=void 0,F=void 0;if(D){E=D[1];F=D[2];C[1]=C[1].replace(D[0],"")}else{D=C[0].split(/\s+/);E=D[4];F=D[5]}z=""+C[0]+A+"raddr "+E+" rport "+F+" "+C[1]}return z},addAudioNack:function y(z){__p&&__p();var A=[];z=z.split("\r\n").map(function(B){var C="";if(A.length>0&&(/^a=rtpmap:(\d+)/.test(B)||/^a=ssrc/.test(B)||/^m=/.test(B))){C+=this._getrtcpFeedbackLinesFromAudioFMTs(A)+"\r\n";A=[]}if(/^m=audio/.test(B))A=B.match(/^m=audio\s+[\d\/]+\s+[\w\/]+([\s+\d+]+)/)[1].trim().split(" ");return C+B}.bind(this)).join("\r\n");if(A.length>0)z+="\r\n"+this._getrtcpFeedbackLinesFromAudioFMTs(A);return z},addSetup:function y(z){if(z.indexOf("a=setup:")>=0)return z;var A=z.split("\r\n"),B=A.findIndex(function(D){return D.startsWith("s=")}),C=A.findIndex(function(D,E){return E>B&&D.startsWith("a=")});A.splice(C,0,"a=setup:actpass");return A.join("\r\n")},_replaceFmtp:function y(z,A,B,C){var D=z==A?[]:z.substr(A.length).split(";"),E=D.findIndex(function(G){return G.startsWith(B+"=")}),F=B+"="+C;if(E<0)D.push(F);else D[E]=F;return""+A+D.join(";")},_addFmtpToMediaSection:function y(z,A,B,C){__p&&__p();var D=new RegExp("^a=rtpmap:(\\d+)\\s"+A),E=z.findIndex(function(J){return J.match(D)});if(E<0)return z;var F=z[E].match(D),G=F[1],H="a=fmtp:"+G+" ",I=z.findIndex(function(J){return J.startsWith(H)});if(I===-1){I=E+1;z.splice(I,0,H)}z[I]=this._replaceFmtp(z[I],H,B,C);return z},addFmtp:function y(z,A,B,C){__p&&__p();var D=z.split("\r\n"),E=-1;for(var F=0;F<=D.length;F++)if(F===D.length||D[F].startsWith("m=")){if(E!==-1){var G=D.splice(E,F-E),H=this._addFmtpToMediaSection(G,A,B,C);D.splice.apply(D,[E,0].concat(H));F=E+1+H.length}E=F}return D.join("\r\n")},_getrtcpFeedbackLinesFromAudioFMTs:function y(z){return z.map(function(A){return"a=rtcp-fb:"+A+" nack"}).join("\r\n")},removeFEC:function y(z){__p&&__p();var A=z.split("\r\n"),B=void 0,C=void 0;for(var D=0;D<A.length;D++){if(A[D].match(/^a=rtpmap:\d+\s+red\//))B=D;if(A[D].match(/^m=video/))C=D}if(B&&C)o(A,B,C);return A.join("\r\n")},removeH264:function y(z){__p&&__p();var A,B=z,C=function C(){var D=B.split("\r\n"),E=/^a=rtpmap:\d+\s+H264\//,F=D.findIndex(function(I){return E.test(I)}),G=/^m=video/,H=D.findIndex(function(I){return G.test(I)});if(F==-1||H==-1)return"break";B=p(D,F,H).join("\r\n")};do{var A=C();if(A==="break")break}while(true);return B},removeVP9:function y(z){var A=z.split("\r\n"),B=/^a=rtpmap:\d+\s+VP9\//,C=A.findIndex(function(F){return B.test(F)}),D=/^m=video/,E=A.findIndex(function(F){return D.test(F)});return C!==-1&&E!==-1?p(A,C,E).join("\r\n"):z},removeUnknownRtpHeaderExtensions:function y(z){var A=z.split("\r\n");A=A.filter(function(B){return!B.match(/^a=extmap:/)||m.some(function(C){return B.includes(C)})});return A.join("\r\n")},isVideoSupported:function y(z){return!!z&&(z.indexOf("m=video")!==-1&&z.indexOf(h)===-1||q.getFBFeatures(z).includes("video"))},setDtlsRole:function y(z,A){if(!z.match(/setup:(active|passive|actpass)/))return z.replace(/(a=fingerprint:.+)/g,"$1\r\na=setup:"+A);else return z.replace(/setup:actpass/g,"setup:"+A)},setVideoBitrateConstraint:function y(z){var A=720;if(z.match(/^b=AS:/m))return z;z=z.replace(/^a=mid:video\r\n/m,"a=mid:video\r\nb=AS:"+A+"\r\n");return z},removeSdparta:function y(z){__p&&__p();var A=z.split("\r\n"),B="audio",C=false,D=-1;for(var E=0;E<A.length;E++){var F=A[E];if(F.indexOf("m=audio")===0)B="audio";if(F.indexOf("m=video")===0){C=true;B="video"}if(F.indexOf("a=mid:sdparta_")===0)A[E]="a=mid:"+B;if(F.indexOf("a=group:BUNDLE sdparta_")===0)D=E}if(D>-1)if(C)A[D]="a=group:BUNDLE audio video";else A[D]="a=group:BUNDLE audio";return A.join("\r\n")},useDTLSOverCrypto:function y(z){if(!(c("UserAgent").isBrowser("Chrome >= 57")||c("UserAgent").isBrowser("Opera >= 44")))return z;if(!/^a=fingerprint:/m.test(z))return z;return z.split("\r\n").filter(function(A){return A.indexOf("a=crypto:")!==0}).join("\r\n")},validateOfferSdp:function y(z,A){__p&&__p();var B;if(z.split(":")[0]==="LIVE"){var B=function(){__p&&__p();var C=/^m=/,D=/^m=audio/,E=/^m=video/,F=/^a=ssrc:/,G=A.split("\r\n"),H=[];for(var I=G.length-1;I>=0;I--)if(C.test(G[I]))H.push(G.splice(I));var J=false,K=false;H.forEach(function(L){if(D.test(L[0])&&!J)J=L.some(function(M){return F.test(M)});else if(E.test(L[0])&&!K)K=L.some(function(M){return F.test(M)})});return{v:J&&K}}();if(typeof B==="object")return B.v}return true},clearFirefoxInactiveDataChannelBlock:function y(z){__p&&__p();if(!c("UserAgent").isBrowser("Firefox"))return z;var A=z.split(s),B=A.findIndex(function(F){return F.startsWith("m=application")});if(B===-1)return z;var C=A.slice(B),D=C.findIndex(function(F,G){return G>0&&F.startsWith("m=")});if(D!==-1)C=C.slice(0,D);if(C[0]!=null&&C[0].endsWith("0")&&C.some(function(F){return F.startsWith("a=inactive")})){var E=C.findIndex(function(F){return F.startsWith("c=")});return[].concat(A.slice(0,B+1+(E!==-1?E:0)),A.slice(B+C.length)).join(s)}return z},addFBFeatures:t,getFBFeatures:u},r="a=x-fb-feature:",s="\r\n";function t(y){for(var z=arguments.length,A=Array(z>1?z-1:0),B=1;B<z;B++)A[B-1]=arguments[B];if(A.length<1)return y;var C=v(y),D=C[0],E=C[1],F=D.split(s),G=w(F),H=F.filter(function(J){return!J.startsWith(r)}),I=1+H.map(function(J){return J?J.substr(0,2):""}).lastIndexOf("a=")||H.length;return[].concat(H.slice(0),x([].concat(G,A)).map(function(J){return""+r+J}),H.slice(I),[E?[E.trim(),""].join(s):""]).join(s)}function u(y){var z=v(y),A=z[0];return w(A.split(s))}function v(y){__p&&__p();if(!y)return["",""];var z=y.trim().split(s),A=0;while(A<z.length){if(z[A].startsWith("m="))break;A++}if(A===z.length)return[y.trim(),""];return[z.slice(0,A).join(s).trim(),z.slice(A).join(s).trim()]}function w(y){return x(y.filter(function(z){return z.startsWith(r)}).map(function(z){return z.substr(r.length)}))}function x(y){__p&&__p();var z=Object.create(null);for(var A=y,B=Array.isArray(A),C=0,A=B?A:A[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var D;if(B){if(C>=A.length)break;D=A[C++]}else{C=A.next();if(C.done)break;D=C.value}var E=D;if(E)z[E]=true}return Object.keys(z).sort()}f.exports=q}),null);
__d("FBRTCMessage",["FBRTCConstants","FBRTCExperiment","FBRTCSdpUtils","FBRTCSupport"],(function a(b,c,d,e,f,g){__p&&__p();var h="mobile";function i(j){"use strict";__p&&__p();if(!this.$FBRTCMessage1(j))throw new Error("invalid webrtc message");this.originalMessageData=j;this.peerID=j.from;this.callID=parseInt(j.call_id,10);this.msg=JSON.parse(j.payload);if(this.msg.json_payload){this.escalationName=this.msg.sessionName;this.msg=this.msg.json_payload}this.msgType=this.msg.type;this.msgID=this.msg.msg_id;this.ackID=this.msg.ack_id;this.source=j.source;this.peerSupportsVideoInterop=!!this.msg.supports_video_interop;this.$FBRTCMessage2();this.$FBRTCMessage3();this.$FBRTCMessage4();this.$FBRTCMessage5()}i.prototype.$FBRTCMessage1=function(j){"use strict";return j.from&&j.call_id&&j.payload};i.prototype.$FBRTCMessage2=function(){"use strict";if(c("FBRTCSupport").isVideoInteropSupported()&&this.peerSupportsVideoInterop)return;if(this.isFromMobile())this.disableVideo()};i.prototype.disableVideo=function(){"use strict";if(this.msg.sdp)this.msg.sdp=c("FBRTCSdpUtils").disableVideo(this.msg.sdp);if(this.msgType===c("FBRTCConstants").PayloadType.SET_VIDEO||this.msgType===c("FBRTCConstants").PayloadType.OFFER||this.msgType===c("FBRTCConstants").PayloadType.ICERESTART_OFFER||this.msgType===c("FBRTCConstants").PayloadType.ANSWER||this.msgType===c("FBRTCConstants").PayloadType.ICERESTART_ANSWER)this.msg.videoon=false};i.prototype.$FBRTCMessage3=function(){"use strict";if(this.isFromMobile()&&this.msg.sdp&&this.msgType!==c("FBRTCConstants").PayloadType.ICE_CANDIDATE)this.msg.sdp=c("FBRTCSdpUtils").removeFEC(this.msg.sdp)};i.prototype.$FBRTCMessage4=function(){"use strict";if(this.isFromMobile()&&c("FBRTCSupport").isWebrtcSupported()&&this.msg.sdp&&this.msgType!==c("FBRTCConstants").PayloadType.ICE_CANDIDATE){var j=c("FBRTCExperiment").gen("rtc_browser_use_h264"),k=j.getParam("allow_h264","no");if(k!=="yes")this.msg.sdp=c("FBRTCSdpUtils").removeH264(this.msg.sdp)}};i.prototype.$FBRTCMessage5=function(){"use strict";if(this.isFromMobile()&&c("FBRTCSupport").isWebrtcSupported()&&this.msg.sdp&&this.msgType!==c("FBRTCConstants").PayloadType.ICE_CANDIDATE){var j=c("FBRTCExperiment").gen("rtc_browser_use_vp9"),k=j.getParam("allow_vp9","no");if(k!=="yes")this.msg.sdp=c("FBRTCSdpUtils").removeVP9(this.msg.sdp)}};i.prototype.isOffer=function(){"use strict";return this.msgType===c("FBRTCConstants").PayloadType.OFFER};i.prototype.isFromMobile=function(){"use strict";return this.source===h};i.prototype.isRemoteVideoSupported=function(){"use strict";if(!this.msg.sdp||this.msgType===c("FBRTCConstants").PayloadType.ICE_CANDIDATE)return true;return c("FBRTCSdpUtils").isVideoSupported(this.msg.sdp)};i.prototype.isRetry=function(){"use strict";return!!this.msg.flag};i.prototype.isForCall=function(j,k){"use strict";if(this.escalationName&&(this.msgType===c("FBRTCConstants").PayloadType.HANGUP||this.msgType===c("FBRTCConstants").PayloadType.SWITCH_TO_MULTIWAY))return k===this.escalationName;return!j||j===this.callID||this.msgType===c("FBRTCConstants").PayloadType.OFFER||this.msgType===c("FBRTCConstants").PayloadType.ICERESTART_OFFER||this.msgType===c("FBRTCConstants").PayloadType.PCRESTART_OFFER||this.msgType===c("FBRTCConstants").PayloadType.ICE_CANDIDATE};i.prototype.getSignalingExperiments=function(){"use strict";if(this.isFromMobile()&&!this.msg.experiments)return["sdp_update"];return this.msg.experiments};f.exports=i}),null);
__d("FBRTCMessageDedup",[],(function a(b,c,d,e,f,g){__p&&__p();var h={},i={check:function j(k,l,m){if(!h[k])h[k]={};if(!h[k][l])h[k][l]={};if(h[k][l][m])return false;h[k][l][m]=true;return true}};f.exports=i}),null);
__d("BanzaiScribe",["Banzai"],(function a(b,c,d,e,f,g){function h(j){return{log:function k(l,m,n){var o=[m];if(n!=null)o.push(n);c("Banzai").post("scribe:"+l,o,j)}}}var i=h({});i.create=h;f.exports=i}),null);
__d("SamplingPolicyBase",[],(function a(b,c,d,e,f,g){__p&&__p();function h(){"use strict";throw new Error("Tried to instantiate SamplingPolicyBase")}h.prototype.getName=function(){"use strict";return this.name};h.prototype.isSampled=function(){"use strict";if(typeof this.sampled=="undefined")this.sampled=this.decideIfSampled();return this.sampled};f.exports=h}),null);
__d("FbtraceForcedByServerPolicy",["FbtraceForcedByServer","SamplingPolicyBase"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();var h=void 0;function i(){this.name="FbtraceForcedByServerPolicy"}i.get=function(){if(typeof h=="undefined")h=new i();return h};function j(){return c("FbtraceForcedByServer").forced}Object.assign(i.prototype,c("SamplingPolicyBase").prototype,{decideIfSampled:j});f.exports=i}),null);
__d("guardFunction",[],(function a(b,c,d,e,f,g){function h(i,j,k){return function(){if(i.apply(k||this,arguments))j.apply(k||this,arguments)}}f.exports=h}),null);
__d("Fbtrace",["Arbiter","ArtilleryTraceIDUtils","BanzaiScribe","FbtraceForcedByServer","FbtraceForcedByServerPolicy","SiteData","guardFunction"],(function a(b,c,d,e,f,g){"use strict";__p&&__p();function h(){Object.assign(this,h)}Object.assign(h,{isOn:function s(){return false},replySend:function s(t,u){},requestSend:function s(t,u,v){m(t,u);return{metadata:function w(){return undefined},replyReceive:function w(v){}}}});var i=new h();function j(s,t,u){__p&&__p();if(!s)throw{name:"ArgumentError",message:"no valid service name specified"};if(!t)throw{name:"ArgumentError",message:"no valid version specified"};var v=c("BanzaiScribe"),w=0,x=c("ArtilleryTraceIDUtils").newTraceId(),y=c("ArtilleryTraceIDUtils").newObjectId(),z=c("ArtilleryTraceIDUtils").traceIdToBucket(x),A={service:s,version:t},B=function B(G){if(typeof G=="undefined")return"undefined";if(typeof G!="string")G=B(JSON.stringify(G));return G},C=function C(u){var G="";for(var H in u){if(G.length>0)G+="\x02";G+=B(H)+"\x03"+B(u[H])}return G},D=function D(G,y,event,u,H){w++;return[H,w,x,G,y,B(event),C(u)].join("\x01")},E=function E(G,y,event,u,H){if(!H&&typeof H=="undefined")H=Date.now()*1e3;var I=D(G,y,event,u,H);v.log("fbtrace",I,z)},F=function F(){return y};E(c("ArtilleryTraceIDUtils").getDummyId(),y,"#rqrecv",Object.assign(u||{},A));Object.assign(this,j,{replySend:function G(H,u){u=babelHelpers["extends"]({},u,A,{success:H?"true":"false"});E(c("ArtilleryTraceIDUtils").getDummyId(),y,"#rpsend",u)},requestSend:function G(H,I,u){m(H,I);var J=F(),y=c("ArtilleryTraceIDUtils").newObjectId();u=babelHelpers["extends"]({},u,A,{op:H,"remote:service":I});E(J,y,"#rqsend",u);return{metadata:function K(){return x+y},replyReceive:function K(u){E(J,y,"#rprecv",Object.assign(u||{},A))},parentNode:this}}})}Object.assign(j,{isOn:function s(){return true}});function k(){return i}function l(s,t,u){u=u||{};u.init=true;var v=c("FbtraceForcedByServerPolicy").get();if(v.isSampled())return new j(s,t,u);else return new h()}function m(s,t){if(!s)throw{name:"ArgumentError",message:"no valid operation specified"};if(!t)throw{name:"ArgumentError",message:"no valid remote:service specified"}}function n(s,t){var u=i,v=void 0;i=s;try{v=t()}finally{i=u}return v}var o=function o(s,t){__p&&__p();var u=k(),v=t.request,w=false;if(!u.isOn()&&c("FbtraceForcedByServer").forced&&/\/upload\/(?:composer|photos)\/|\/ajax\/composerx\/attachment\/media\//.test(v.uri.toString())){u=l("photo_upload_kludge",String(c("SiteData").client_revision||"dev"),{policy:"PhotoUpload"});w=true}if(u.isOn()){var x=w?{policy:"PhotoUpload"}:{};if(v.userActionId)x.user_action_id=v.userActionId;var y=u.requestSend(v.uri.toString(),"www",x);v.fbtraceRemoteNode=y;v.transport.setRequestHeader("X-Fbtrace-Meta",y.metadata())}},p=function p(s,t){t.request.fbtraceRemoteNode.replyReceive({is_last:t.response.is_last,success:true});setTimeout(function(){t.request.fbtraceRemoteNode.parentNode.replySend(true,{})},0)},q=function q(s,t){t.request.fbtraceRemoteNode.replyReceive({is_last:t.response.is_last,success:false,error_code:t.response.error,error_summary:t.response.errorSummary,error_description:t.response.errorDescription});setTimeout(function(){t.request.fbtraceRemoteNode.parentNode.replySend(false,{})},0)},r=function r(s,t){return t.request.fbtraceRemoteNode};c("Arbiter").subscribe("AsyncRequest/will_send",o);c("Arbiter").subscribe("AsyncRequest/response",c("guardFunction")(r,p));c("Arbiter").subscribe("AsyncRequest/error",c("guardFunction")(r,q));f.exports={defaultNode:k,requestReceive:l,withDefaultNode:n}}),null);
__d("XCollabCallSendMessageController",["XController"],(function a(b,c,d,e,f,g){f.exports=c("XController").create("/collab/sendmessage/",{recipient_id:{type:"Int",required:true},msg_id:{type:"Int",required:true},message_info:{type:"String",required:true},webrtc_fbtrace:{type:"Int"}})}),null);
__d("XVideoCallSendMessageController",["XController"],(function a(b,c,d,e,f,g){f.exports=c("XController").create("/videocall/sendmessage/",{recipient_id:{type:"Int",required:true},msg_id:{type:"Int",required:true},message_info:{type:"String",required:true},webrtc_fbtrace:{type:"Int"}})}),null);
__d("FBRTCMessageSender",["errorCode","CurrentUser","FBRTCConfig","FBRTCConstants","FBRTCLogger","FBRTCSupport","FBRTCUtils","Fbtrace","Map","RTCConfig","SiteData","XCollabCallSendMessageController","XVideoCallSendMessageController"],(function a(b,c,d,e,f,g,h){__p&&__p();var i=0;function j(){"use strict";this.onSendFailure=null;this.$FBRTCMessageSender1=c("FBRTCLogger").getInstance()}j.prototype.sendOffer=function(k,l,m,n,o){"use strict";return this.$FBRTCMessageSender2(c("FBRTCConstants").PayloadType.OFFER,k,l,m,n,o)};j.prototype.sendAnswer=function(k,l,m,n,o,p){"use strict";return this.$FBRTCMessageSender2(c("FBRTCConstants").PayloadType.ANSWER,k,l,m,n,o,p)};j.prototype.sendPCRestartOffer=function(k,l,m,n,o){"use strict";return this.$FBRTCMessageSender2(c("FBRTCConstants").PayloadType.PCRESTART_OFFER,k,l,m,n,o)};j.prototype.sendSdpUpdate=function(k,l,m,n,o){"use strict";return this.$FBRTCMessageSender2(c("FBRTCConstants").PayloadType.SDP_UPDATE,k,l,m,n,o)};j.prototype.resendSdpMessage=function(k,l){"use strict";l.flag=1;this.$FBRTCMessageSender3(k,l)};j.prototype.resendPayload=function(k,l){"use strict";l.flag=1;this.$FBRTCMessageSender4(k,l)};j.prototype.$FBRTCMessageSender2=function(k,l,m,n,o,p,q){"use strict";__p&&__p();var r=this.$FBRTCMessageSender5(m,k);r.sdp=n;if(k===c("FBRTCConstants").PayloadType.OFFER){r.handlescollision=true;r.pranswer=false}if(k===c("FBRTCConstants").PayloadType.ANSWER&&q){r.escalation_conference_name=q.escalationConferenceName;r.negotiated_escalation_support=q.negotiatedEscalationSupport}if(k===c("FBRTCConstants").PayloadType.OFFER||k===c("FBRTCConstants").PayloadType.ANSWER){r.icerestart=false;r.experiments=c("FBRTCConfig").supportedSignalingExperiments()}r.videoon=o;r.attributes=p;r.ull=c("FBRTCConstants").convertFromUploadLogLevel(c("FBRTCUtils").getLocalUploadLogLevel());this.$FBRTCMessageSender3(l,r);return r};j.prototype.sendIceCandidate=function(k,l,m){"use strict";var n=this.$FBRTCMessageSender5(l,c("FBRTCConstants").PayloadType.ICE_CANDIDATE);n.sdp_mid=m.sdpMid;n.label=m.sdpMLineIndex;n.sdp=m.candidate;this.$FBRTCMessageSender4(k,n)};j.prototype.sendHangup=function(k,l,m,n,o){"use strict";var p=this.$FBRTCMessageSender5(l,c("FBRTCConstants").PayloadType.HANGUP);p.reason=c("FBRTCConstants").callEndReasonString(m);p.subreason=o||"";this.$FBRTCMessageSender4(k,p,n)};j.prototype.sendOtherDismiss=function(k){"use strict";var l=this.$FBRTCMessageSender5(k,c("FBRTCConstants").PayloadType.OTHER_DISMISS);this.$FBRTCMessageSender4(c("CurrentUser").getID(),l)};j.prototype.sendOfferAck=function(k,l,m){var n=arguments.length<=3||arguments[3]===undefined?new(c("Map"))():arguments[3];"use strict";this.$FBRTCMessageSender6(k,l,m,c("FBRTCConstants").PayloadType.OFFER_ACK,n)};j.prototype.sendOfferNack=function(k,l,m){"use strict";this.$FBRTCMessageSender6(k,l,m,c("FBRTCConstants").PayloadType.OFFER_NACK,new(c("Map"))([["error_code",1356043]]))};j.prototype.sendAnswerAck=function(k,l,m){"use strict";this.$FBRTCMessageSender6(k,l,m,c("FBRTCConstants").PayloadType.ANSWER_ACK)};j.prototype.sendAck=function(k,l,m){"use strict";this.$FBRTCMessageSender6(k,l,m,c("FBRTCConstants").PayloadType.ACK,new(c("Map"))([["ack_type",m.type]]))};j.prototype.sendMuteStateUpdate=function(k,l,m){"use strict";var n=this.$FBRTCMessageSender5(l,c("FBRTCConstants").PayloadType.SET_VIDEO);n.videoon=m;this.$FBRTCMessageSender4(k,n)};j.prototype.sendVideoEscalationRequest=function(k,l,m){"use strict";return this.sendVideoRequestResponse(k,l,0,m)};j.prototype.sendVideoRequestResponse=function(k,l,m,n){"use strict";var o=this.$FBRTCMessageSender5(l,c("FBRTCConstants").PayloadType.VIDEO_REQUEST);o.ack_id=m;o.videoon=n;o.capability=c("FBRTCSupport").getCapabilities();this.$FBRTCMessageSender4(k,o);return o};j.prototype.sendMsgAck=function(){"use strict"};j.prototype.sendOk=function(){"use strict"};j.prototype.sendPranswer=function(){"use strict"};j.prototype.sendIcerestartAnswer=function(){"use strict"};j.prototype.$FBRTCMessageSender5=function(k,l){"use strict";var m=c("FBRTCUtils").generateRandomInt(),n={version:i,type:l,call_id:k,msg_id:m};if(this.$FBRTCMessageSender7(l))n.supports_video_interop=true;return n};j.prototype.$FBRTCMessageSender7=function(k){"use strict";if(c("FBRTCSupport").isVideoInteropSupported())return k===c("FBRTCConstants").PayloadType.OFFER||k===c("FBRTCConstants").PayloadType.ANSWER||k===c("FBRTCConstants").PayloadType.PRANSWER||k===c("FBRTCConstants").PayloadType.ICERESTART_OFFER||k===c("FBRTCConstants").PayloadType.ICERESTART_ANSWER||k===c("FBRTCConstants").PayloadType.PCRESTART_OFFER||k===c("FBRTCConstants").PayloadType.PCRESTART_ANSWER||k===c("FBRTCConstants").PayloadType.SDP_UPDATE||k===c("FBRTCConstants").PayloadType.SET_VIDEO||k===c("FBRTCConstants").PayloadType.VIDEO_REQUEST;return false};j.prototype.$FBRTCMessageSender3=function(k,l){"use strict";this.$FBRTCMessageSender4(k,l,false,true,true)};j.prototype.$FBRTCMessageSender6=function(k,l,m,n){"use strict";__p&&__p();var o=(arguments.length<=4?undefined:arguments[4])||new(c("Map"))(),p=this.$FBRTCMessageSender5(l,n);p.ack_id=m.msg_id;if(m.flag===1)p.flag=1;if(n===c("FBRTCConstants").PayloadType.OFFER_ACK){p.escalation_conference_name=m.escalation_conference_name;p.offer_escalation_support=m.offer_escalation_support&&c("RTCConfig").RtcReceiveMultiwayEscalationGK}p.ull=c("FBRTCConstants").convertFromUploadLogLevel(c("FBRTCUtils").getLocalUploadLogLevel());o.forEach(function(q,r,s){p[r]=q});this.$FBRTCMessageSender4(k,p)};j.prototype.$FBRTCMessageSender4=function(k,l,m,n,o){"use strict";__p&&__p();var p=l.msg_id,q={peer_id:k,call_id:l.call_id,msg_id:p,msg_type:l.type},r={call_id:l.call_id,msg_id:p,user_id:c("CurrentUser").getID(),recipient_id:k,msg_type:l.type,app_id:256281040558,app_version:String(c("SiteData").client_revision||"dev"),op:"sendServerRequest:"+l.type,policy:"WebRTC"},s=c("Fbtrace").requestReceive("browser",String(c("SiteData").client_revision||"dev"),r),t=(c("FBRTCUtils").isPeerVCEndpoint(k)?c("XCollabCallSendMessageController"):c("XVideoCallSendMessageController")).getURIBuilder().setInt("recipient_id",k).setInt("msg_id",p).setString("message_info",JSON.stringify(l)).setInt("webrtc_fbtrace",s.isOn()?1:0).getURI();if(n)var u=this.$FBRTCMessageSender4.bind(this,k,l,m,false,o);var v=this.$FBRTCMessageSender8.bind(this,q),w=this.$FBRTCMessageSender9.bind(this,q,u,o);c("Fbtrace").withDefaultNode(s,function(){c("FBRTCUtils").sendServerRequest(t,v,w,m)});if(this.onMessageSent)this.onMessageSent(k,l);this.$FBRTCMessageSender1.logSentMessage(k,l.call_id,l)};j.prototype.$FBRTCMessageSender8=function(k){"use strict";this.$FBRTCMessageSender1.logSentMessageSuccess(k.peer_id,k.call_id,k.msg_type,k.msg_id)};j.prototype.$FBRTCMessageSender9=function(k,l,m,n){"use strict";__p&&__p();if(n)var o=n.getError?n.getError():n;this.$FBRTCMessageSender1.logSentMessageFailure(k.peer_id,k.call_id,k.msg_type,k.msg_id,o);var p=null;if(o===1356001||o===1356049)p=c("FBRTCConstants").CallEndReason.NO_PERMISSION;else if(o===1356046||o===1356045)p=c("FBRTCConstants").CallEndReason.CALLER_NOT_VISIBLE;else if(o===1356003||o===1356002||o===1356044)p=c("FBRTCConstants").CallEndReason.OTHER_NOT_CAPABLE;if(!p&&l){l();return}if(m&&this.onSendFailure){if(!p)p=c("FBRTCConstants").CallEndReason.SIGNALING_MESSAGE_FAILED;this.onSendFailure(p,o,k.msg_type)}};f.exports=j}),null);
__d("FBRTCIncomingCallController",["fbt","Cache","DocumentTitle","FBRTCCallBlockingStore","FBRTCCallSummary","FBRTCCallSummaryStore","FBRTCCallUIWrapper","FBRTCConstants","FBRTCLocalMessageQueue","FBRTCLogger","FBRTCMessage","FBRTCMessageDedup","FBRTCMessageSender","FBRTCUtils","MercuryIDs","MercuryParticipants","UserActivity","FBRTCSupport"],(function a(b,c,d,e,f,g,h){__p&&__p();var i=30;function j(k,l,m){"use strict";__p&&__p();this.$FBRTCIncomingCallController1=k;this.$FBRTCIncomingCallController2=l;this.$FBRTCIncomingCallController3=m;this.$FBRTCIncomingCallController4=null;this.$FBRTCIncomingCallController5=null;this.$FBRTCIncomingCallController6=new(c("FBRTCMessageSender"))();this.$FBRTCIncomingCallController7=new(c("FBRTCLocalMessageQueue"))();this.$FBRTCIncomingCallController8=c("FBRTCCallSummaryStore").getInstance();this.$FBRTCIncomingCallController9=c("FBRTCLogger").getInstance();this.$FBRTCIncomingCallController10=null;this.$FBRTCIncomingCallController11=new(c("Cache"))()}j.prototype.onMessageReceived=function(k){"use strict";__p&&__p();var l;try{l=new(c("FBRTCMessage"))(k)}catch(m){this.$FBRTCIncomingCallController9.logErrorWithoutID("Unknown data: "+JSON.stringify(k));return}if(!c("FBRTCMessageDedup").check(l.peerID,l.callID,l.msgID)){if(l.isOffer()&&this.$FBRTCIncomingCallController12(l))this.$FBRTCIncomingCallController6.sendOfferAck(l.peerID,l.callID,l.msg);this.$FBRTCIncomingCallController9.logInfo(l.peerID,l.callID,"Ignoring message (duplicate): "+l.msgID);return}this.$FBRTCIncomingCallController9.logReceivedMessage(l.peerID,l.callID,l.msg);if(c("FBRTCSupport").isWebrtcSupported()&&l.msgType!==c("FBRTCConstants").PayloadType.OFFER)this.$FBRTCIncomingCallController7.enqueueMessage(l.peerID,l.callID,l.msgID,k);switch(l.msgType){case c("FBRTCConstants").PayloadType.OFFER:this.$FBRTCIncomingCallController13(l);break;case c("FBRTCConstants").PayloadType.HANGUP:this.$FBRTCIncomingCallController14(l);break;case c("FBRTCConstants").PayloadType.OTHER_DISMISS:this.$FBRTCIncomingCallController15(l);break;case c("FBRTCConstants").PayloadType.ICE_CANDIDATE:case c("FBRTCConstants").PayloadType.OFFER_ACK:case c("FBRTCConstants").PayloadType.ANSWER:case c("FBRTCConstants").PayloadType.MSG_ACK:case c("FBRTCConstants").PayloadType.OK:case c("FBRTCConstants").PayloadType.PING:case c("FBRTCConstants").PayloadType.PRANSWER:case c("FBRTCConstants").PayloadType.ICERESTART_OFFER:case c("FBRTCConstants").PayloadType.ICERESTART_ANSWER:case c("FBRTCConstants").PayloadType.PCRESTART_ANSWER:case c("FBRTCConstants").PayloadType.PCRESTART_OFFER:case c("FBRTCConstants").PayloadType.SDP_UPDATE:case c("FBRTCConstants").PayloadType.ANSWER_ACK:case c("FBRTCConstants").PayloadType.SET_VIDEO:case c("FBRTCConstants").PayloadType.OFFER_NACK:case c("FBRTCConstants").PayloadType.VIDEO_REQUEST:case c("FBRTCConstants").PayloadType.ACK:break;default:break}};j.prototype.$FBRTCIncomingCallController13=function(k){"use strict";__p&&__p();var l=k.callID,m,n=k.msg,o=k.peerID;if(this.$FBRTCIncomingCallController16(l))return;if(n.calltype){this.$FBRTCIncomingCallController6.sendOfferNack(o,l,n);return}if(this.$FBRTCIncomingCallController12(k))this.$FBRTCIncomingCallController6.sendOfferAck(o,l,n);else if(!c("FBRTCSupport").isWebrtcSupported())this.$FBRTCIncomingCallController6.sendOfferNack(o,l,n);this.$FBRTCIncomingCallController9.logCallAction(o,l,c("FBRTCLogger").CallAction.RECEIVED_CALL);var p=this.$FBRTCIncomingCallController17(o,l,k);p.setUploadLogLevel(c("FBRTCUtils").getUploadLogLevel(c("FBRTCConstants").convertToUploadLogLevel(n.ull)));if(c("FBRTCCallBlockingStore").getBlockingStatus()){this.$FBRTCIncomingCallController18(o,l,p,c("FBRTCConstants").CallEndReason.IGNORE_CALL,false,false,false,"calling disabled");return}if(this.$FBRTCIncomingCallController4!==null&&!this.$FBRTCIncomingCallController4.isForPeer(o)){this.$FBRTCIncomingCallController18(o,l,p,c("FBRTCConstants").CallEndReason.IN_ANOTHER_CALL,false,false,true);this.$FBRTCIncomingCallController3.onCallMissed(o);return}if(!c("FBRTCSupport").isWebrtcSupported()){this.$FBRTCIncomingCallController18(o,l,p,c("FBRTCConstants").CallEndReason.UNSUPPORTED_VERSION,false,false,false);this.$FBRTCIncomingCallController2.showForIncomingCall(l,o);return}this.$FBRTCIncomingCallController4=new this.$FBRTCIncomingCallController1(o,l);this.$FBRTCIncomingCallController5=p;this.$FBRTCIncomingCallController4.addListener("answerCall",function(q){this.$FBRTCIncomingCallController19(o,l,k,p,q)}.bind(this));this.$FBRTCIncomingCallController4.addListener("ignoreCall",function(){this.$FBRTCIncomingCallController20(o,l,p)}.bind(this));this.$FBRTCIncomingCallController4.addListener("timeout",function(){this.$FBRTCIncomingCallController21(o,l,p)}.bind(this));this.$FBRTCIncomingCallController3.hideDialog();m=n.videoon?c("FBRTCConstants").IncomingCallDialogTypes.VIDEO:c("FBRTCConstants").IncomingCallDialogTypes.AUDIO;this.$FBRTCIncomingCallController4.showIncomingDialog(m);this.$FBRTCIncomingCallController9.logEvent(o,l,"Incoming call dialog shown");this.$FBRTCIncomingCallController22(o)};j.prototype.$FBRTCIncomingCallController22=function(k){"use strict";if(!document.hasFocus())this.$FBRTCIncomingCallController23(k)};j.prototype.$FBRTCIncomingCallController24=function(){"use strict";this.$FBRTCIncomingCallController25()};j.prototype.$FBRTCIncomingCallController23=function(k){"use strict";var l=c("MercuryIDs").getParticipantIDFromUserID(k);c("MercuryParticipants").get(l,function(m){if(!this.$FBRTCIncomingCallController4)return;this.$FBRTCIncomingCallController10=c("DocumentTitle").blink(h._("{name} is calling",[h.param("name",m.short_name)]))}.bind(this));c("UserActivity").subscribeOnce(this.$FBRTCIncomingCallController25.bind(this))};j.prototype.$FBRTCIncomingCallController25=function(){"use strict";if(this.$FBRTCIncomingCallController10){this.$FBRTCIncomingCallController10.stop();this.$FBRTCIncomingCallController10=null}};j.prototype.$FBRTCIncomingCallController26=function(){"use strict";if(this.$FBRTCIncomingCallController4)this.$FBRTCIncomingCallController4.cancel();this.$FBRTCIncomingCallController4=null;this.$FBRTCIncomingCallController5=null;this.$FBRTCIncomingCallController24()};j.prototype.$FBRTCIncomingCallController14=function(k){"use strict";__p&&__p();var l=k.peerID,m=k.callID,n=k.msg;this.$FBRTCIncomingCallController27(m);if(this.$FBRTCIncomingCallController4&&this.$FBRTCIncomingCallController4.isForPeerAndCall(l,m)){var o=n.reason;if(typeof o=="string"||o instanceof String)o=c("FBRTCConstants").endCallReasonFromString(o);this.$FBRTCIncomingCallController18(l,m,this.$FBRTCIncomingCallController5,o,true,true,false);this.$FBRTCIncomingCallController26();if(o!==c("FBRTCConstants").CallEndReason.OTHER_INSTANCE_HANDLED){this.$FBRTCIncomingCallController3.onCallMissed(l);this.$FBRTCIncomingCallController3.showDialog()}}};j.prototype.$FBRTCIncomingCallController12=function(k){"use strict";return c("FBRTCSupport").isWebrtcSupported()};j.prototype.$FBRTCIncomingCallController15=function(k){"use strict";var l=k.callID;this.$FBRTCIncomingCallController27(l);if(!c("FBRTCSupport").isWebrtcSupported())this.$FBRTCIncomingCallController2.dismiss();if(this.$FBRTCIncomingCallController4&&this.$FBRTCIncomingCallController4.isForCall(l))this.$FBRTCIncomingCallController26()};j.prototype.$FBRTCIncomingCallController27=function(k){"use strict";this.$FBRTCIncomingCallController11.set(k,true,null,i)};j.prototype.$FBRTCIncomingCallController16=function(k){"use strict";return this.$FBRTCIncomingCallController11.has(k)};j.prototype.$FBRTCIncomingCallController17=function(k,l,m){"use strict";var n=new(c("FBRTCCallSummary"))({peerID:k,callID:l,isCaller:false});n.onFullMessageReceived(m);n.onOfferAckSent(m.msg);return n};j.prototype.$FBRTCIncomingCallController19=function(k,l,m,n,o){"use strict";var p=!m.msg.videoon;this.$FBRTCIncomingCallController9.logCallAction(k,l,c("FBRTCLogger").CallAction.ANSWER_CALL);this.$FBRTCIncomingCallController6.sendOtherDismiss(l);this.$FBRTCIncomingCallController7.enqueueOffer(k,m.originalMessageData);c("FBRTCCallUIWrapper").openAsCallee(k,l,n,o,p);this.$FBRTCIncomingCallController26()};j.prototype.$FBRTCIncomingCallController20=function(k,l,m){"use strict";this.$FBRTCIncomingCallController18(k,l,m,c("FBRTCConstants").CallEndReason.IGNORE_CALL,false,true,true);this.$FBRTCIncomingCallController26()};j.prototype.$FBRTCIncomingCallController21=function(k,l,m){"use strict";this.$FBRTCIncomingCallController18(k,l,m,c("FBRTCConstants").CallEndReason.NO_ANSWER_TIMEOUT,false,false,false);this.$FBRTCIncomingCallController26();this.$FBRTCIncomingCallController3.onCallMissed(k);this.$FBRTCIncomingCallController3.showDialog()};j.prototype.$FBRTCIncomingCallController18=function(k,l,m,n,o,p,q){__p&&__p();var r=arguments.length<=7||arguments[7]===undefined?null:arguments[7];"use strict";if(q)this.$FBRTCIncomingCallController6.sendHangup(k,l,n);if(p)this.$FBRTCIncomingCallController6.sendOtherDismiss(l);m.onCallEnded(n,o,null,r);m.save(this.$FBRTCIncomingCallController8);var s=c("FBRTCConstants").fullCallEndReasonString(n,o);this.$FBRTCIncomingCallController9.logCallAction(k,l,c("FBRTCLogger").CallAction.END_CALL,s)};f.exports=j}),null);