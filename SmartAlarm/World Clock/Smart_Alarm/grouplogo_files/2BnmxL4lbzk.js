if (self.CavalryLogger) { CavalryLogger.start_js(["G6Y4u"]); }

__d("DataSource",["ArbiterMixin","AsyncRequest","TokenizeUtil","SearchI18nMatch","createArrayFromMixed","createObjectFrom","emptyFunction","mixin","str2rstr","Map"],(function a(b,c,d,e,f,g){__p&&__p();var h,i;h=babelHelpers.inherits(j,c("mixin")(c("ArbiterMixin")));i=h&&h.prototype;function j(k){"use strict";__p&&__p();i.constructor.call(this);this._maxResults=k.maxResults||10;this.token=k.token;this.queryData=k.queryData||{};this.queryEndpoint=k.queryEndpoint||"";this.bootstrapData=k.bootstrapData||{};this.bootstrapEndpoint=k.bootstrapEndpoint||"";this.globalKeywordsEndpoint=k.globalKeywordsEndpoint||"";this._indexedFields=k.indexedFields||["text","tokens"];this._titleFields=k.titleFields||[];this._alwaysPrefixMatch=k.alwaysPrefixMatch||false;this._deduplicationKey=k.deduplicationKey||null;this._enabledLocalCache=k.enabledLocalCache!=null?k.enabledLocalCache:true;this._enabledQueryCache=k.enabledQueryCache!=null?k.enabledQueryCache:true;this._disableAllCaches=k.disableAllCaches!=null?k.disableAllCaches:false;this._enabledMergeUids=k.enabledMergeUids!=null?k.enabledMergeUids:false;this._queryExactMatch=k.queryExactMatch||false;this._acrossTransitions=k.acrossTransitions||false;this._minQueryLength=k.minQueryLength||-1;this._enforceNewRequestIDUponFetch=k.enforceNewRequestIDUponFetch||false;this._minExactMatchLength=4;this._filters=[];this._headerflags=k.headerflags||new(c("Map"))();this.transport=null;this.setExclusions(k.exclusions);this.backendUnicodeMatch=new(c("SearchI18nMatch"))({prefix_kana_hiragana_to_katakana:!!k.kanaNormalization});this.cacheUnicodeMatch=new(c("SearchI18nMatch"))({prefix_kana_hiragana_to_katakana:!!k.kanaNormalization})}j.prototype.init=function(){"use strict";this.init=c("emptyFunction");this._fields=c("createObjectFrom")(this._indexedFields);this._activeQueries=0;this.dirty()};j.prototype.dirty=function(){"use strict";__p&&__p();this.value="";this._bootstrapped=false;this._bootstrapping=false;this._data=Object.create(null);this.localCache={};this.queryCache={};this.queryIDs={};this.inform("dirty",{});return this};j.prototype.bootstrap=function(){var k=arguments.length<=0||arguments[0]===undefined?false:arguments[0];"use strict";if(this._bootstrapped&&!k)return;this.bootstrapWithoutToken();this._bootstrapped=true;this._bootstrapping=true;this.inform("bootstrap",{bootstrapping:true})};j.prototype.bootstrapWithoutToken=function(){"use strict";this.fetch(this.bootstrapEndpoint,this.bootstrapData,{bootstrap:true,token:this.token})};j.prototype.bootstrapWithToken=function(){"use strict";var k=babelHelpers["extends"]({},this.bootstrapData);k.token=this.token;this.fetch(this.bootstrapEndpoint,k,{bootstrap:true,replaceCache:true,value:""})};j.prototype.query=function(k,l,m,n,o){"use strict";__p&&__p();this.inform("beforeQuery",babelHelpers["extends"]({value:k,local_only:l,exclusions:m,time_waited:n},o));var p=Date.now();if(this._disableAllCaches){this.dirty();if(!k){this.bootstrap();return true}}else if(!this._enabledQueryCache){this.queryCache={};this.queryIDs={}}var q=this.buildUids(k,[],m),r=this.respond(k,q);this.value=k;this.inform("query",babelHelpers["extends"]({value:k,results:r},o));var s=this.tokenizeBackend(k).flatValue;if(l||!s||this._isQueryTooShort(s)||!this.queryEndpoint||Object.prototype.hasOwnProperty.call(this.getQueryCache(),s)||!this.shouldFetchMoreResults(r)){this.inform("logPerformanceTiming",babelHelpers["extends"]({field:"cache_keypress_render",value:Date.now()-p},o));this.inform("completeCacheFetch");return false}this.inform("queryEndpoint",babelHelpers["extends"]({value:k},o));this.fetch(this.queryEndpoint,this.getQueryData(k,q),babelHelpers["extends"]({value:k,exclusions:m},o));return true};j.prototype._isQueryTooShort=function(k){"use strict";return k.length<this._minQueryLength};j.prototype._tokenize=function(k,l){"use strict";return c("TokenizeUtil").parse(k,l)};j.prototype.tokenizeBackend=function(k,l){"use strict";k=this.backendUnicodeMatch.prefixMatchPrepare(k);return this._tokenize(k,l)};j.prototype.tokenizeCache=function(k,l){"use strict";k=this.cacheUnicodeMatch.prefixMatchPrepare(k);return this._tokenize(k,l)};j.prototype.shouldFetchMoreResults=function(k){"use strict";return k.length<this._maxResults};j.prototype.getQueryData=function(k,l){"use strict";var m=babelHelpers["extends"]({value:k},this.queryData);l=l||[];if(l.length)m.existing_ids=l.join(",");if(this._bootstrapping)m.bsp=true;return m};j.prototype.setQueryData=function(k,l){"use strict";if(l)this.queryData={};Object.assign(this.queryData,k);return this};j.prototype.setBootstrapData=function(k,l){"use strict";if(l)this.bootstrapData={};Object.assign(this.bootstrapData,k);return this};j.prototype.getExclusions=function(){"use strict";return c("createArrayFromMixed")(this._exclusions)};j.prototype.setExclusions=function(k){"use strict";this._exclusions=k?k.map(String):[]};j.prototype.addFilter=function(k){"use strict";var l=this._filters;l.push(k);return{remove:function m(){l.splice(l.indexOf(k),1)}}};j.prototype.clearFilters=function(){"use strict";this._filters=[]};j.prototype.notify=function(k,l,m,n){"use strict";var o=this.buildData(l);this.inform("notify",{value:k,results:o,isAsync:!!m,rootid:n});return o};j.prototype.respond=function(k,l,m){"use strict";var n=this.buildData(l);this.processResults(k,n,m);this.inform("respond",{value:k,results:n,isAsync:!!m});return n};j.prototype.respondWithResults=function(k,l,m){"use strict";this.processResults(k,l,m);this.inform("respond",{value:k,results:l,isAsync:!!m});return l};j.prototype.processResults=function(k,l,m){"use strict";__p&&__p();if(this.bootstrapData.alwaysShowEcho){var n=-1;for(var o=0;o<l.length;++o)if(l[o].text.toLowerCase()===k.toLowerCase()){n=o;break}var p={};if(n===-1){p={bootstrapped:false,index:0,query:k,render_type:"hashtag",text:k,type:"hashtag",uid:this.getUniqueID()};l.map(function(q){q.index+=1});l.unshift(p)}else if(n>0){p=l.splice(n,1)[0];l.unshift(p);l.map(function(q,r){q.index=r})}}};j.prototype.getUniqueID=function(){"use strict";var k="_"+Math.random().toString(36).substr(2,9);while(this._data[k]!==undefined)k="_"+Math.random().toString(36).substr(2,9);return k};j.prototype.fetch=function(k,l,m){"use strict";__p&&__p();if(!k)return;if(this._enforceNewRequestIDUponFetch||l.request_id===undefined){l.request_id=this._guid();m.request_id=l.request_id}var n=new(c("AsyncRequest"))().setURI(k).setData(l).setMethod("GET").setReadOnly(true).setAllowCrossPageTransition(this._acrossTransitions).setHandler(function(v){this.fetchHandler(v,m||{})}.bind(this));if(k===this.queryEndpoint){for(var o=this._headerflags,p=Array.isArray(o),q=0,o=p?o:o[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var r;if(p){if(q>=o.length)break;r=o[q++]}else{q=o.next();if(q.done)break;r=q.value}var s=r,t=s[0],u=s[1];n.setRequestHeader(t,u)}n.setFinallyHandler(function(){this._activeQueries--;if(!this._activeQueries)this.inform("activity",{activity:false})}.bind(this))}n.setErrorHandler(function(v){return this.asyncErrorHandler(v,m)}.bind(this));this.inform("beforeFetch",{request:n,fetch_context:m});n.send();this.transport=n.transport;if(k===this.queryEndpoint){if(!this._activeQueries)this.inform("activity",{activity:true});this._activeQueries++}};j.prototype.fetchHandler=function(k,l){"use strict";__p&&__p();var m=l.value,n=l.exclusions;if(k.getPayload().requestID!==undefined)l.request_id=k.getPayload().requestID;var o=this.getQueryIDs(),p=this.tokenizeBackend(m||"").flatValue;o[p]=l.request_id;if(!m&&l.replaceCache)this.localCache={};this.inform("buildQueryCache",{});var q=k.getPayload().entries;this.addEntries(q,m);this.inform("fetchComplete",{entries:q,response:k,value:m,fetch_context:l});var r=!m&&this.value?this.value:m;this.respond(r,this.buildUids(r,[],n),true);if(!m){if(this._bootstrapping){this._bootstrapping=false;this.inform("bootstrap",{bootstrapping:false})}if(l.token&&k.getPayload().token!==l.token)this.bootstrapWithToken()}};j.prototype.addEntries=function(k,l){"use strict";__p&&__p();var m=this.processEntries(c("createArrayFromMixed")(k||[]),l),n=m;if(this._enabledMergeUids)n=this.buildUids(l,m);if(l){var o=this.getQueryCache(),p=this.tokenizeBackend(l).flatValue;o[p]=n}else this.fillCache(n);return m};j.prototype.processEntries=function(k,l){"use strict";__p&&__p();return k.map(function(m,n){__p&&__p();var o=m.uid=m.uid+"",p=this.getEntry(o);if(!p){p=m;p.query=l;p.bootstrapped=!l;this.setEntry(o,p)}else Object.assign(p,m);this.processEntry(p,l);p.index===undefined&&(p.index=n);return o},this)};j.prototype.processEntry=function(k,l){"use strict"};j.prototype.getAllEntries=function(){"use strict";return this._data||{}};j.prototype.getEntry=function(k){"use strict";return this._data[k]||null};j.prototype.setEntry=function(k,l){"use strict";this._data[k]=l};j.prototype.fillCache=function(k){"use strict";__p&&__p();if(!this._enabledLocalCache)return;var l=this.localCache;k.forEach(function(m){__p&&__p();var n=this.getEntry(m);if(!n)return;var o=this.tokenizeCache(this.getTextToIndex(n)).tokens;for(var p=0,q=o.length;p<q;++p){var r=o[p];if(!Object.prototype.hasOwnProperty.call(l,r))l[r]={};l[r][m]=true}},this)};j.prototype.getTextToIndex=function(k){"use strict";if(k.textToIndex&&!k.needs_update)return k.textToIndex;k.needs_update=false;k.textToIndex=this.getTextToIndexFromFields(k,this._indexedFields);return k.textToIndex};j.prototype.getTextToIndexFromFields=function(k,l){"use strict";var m=[];for(var n=0;n<l.length;++n){var o=k[l[n]];if(o)m.push(o.join?o.join(" "):o)}return m.join(" ")};j.prototype.mergeUids=function(k,l,m,n){"use strict";this.inform("mergeUids",{local_uids:k,query_uids:l,new_uids:m,value:n});this._checkExtendedMatch(n,k);return this.deduplicateByKey(k.sort(this.bootstrapSort.bind(this)).concat(l,m))};j.prototype.bootstrapSort=function(k,l){"use strict";__p&&__p();var m=this.getEntry(k),n=this.getEntry(l);if(m.extended_match!==n.extended_match)return m.extended_match?1:-1;if(m.index!==n.index)return m.index-n.index;if(m.text.length!==n.text.length)return m.text.length-n.text.length;if(m.text===n.text)return m.uid<n.uid?-1:1;return m.text<n.text?-1:1};j.prototype._checkExtendedMatch=function(k,l){"use strict";var m=this._alwaysPrefixMatch?c("TokenizeUtil").isPrefixMatch:c("TokenizeUtil").isQueryMatch;for(var n=0;n<l.length;++n){var o=this.getEntry(l[n]);o.extended_match=o.tokens?!m(k,o.text):false}};j.prototype.buildUids=function(k,l,m){"use strict";__p&&__p();if(!l)l=[];if(!k)return l;if(!m)m=[];var n=this.buildCacheResults(k,this.localCache),o=this.buildQueryResults(k),p=this.mergeUids(n,o,l,k),q=c("createObjectFrom")(m.concat(this._exclusions)),r=p.filter(function(s){if(Object.prototype.hasOwnProperty.call(q,s)||!this.getEntry(s))return false;for(var t=0;t<this._filters.length;++t)if(!this._filters[t](this.getEntry(s),k))return false;return q[s]=true},this);return this.uidsIncludingExact(k,r)};j.prototype.uidsIncludingExact=function(k,l){"use strict";__p&&__p();var m=l.length;if(m<=this._maxResults||c("str2rstr")(k).length<this._minExactMatchLength)return l;for(var n=0;n<m;++n){var o=this.getEntry(l[n]);o.text_lower||(o.text_lower=o.text.toLowerCase());if(o.text_lower===this.tokenizeCache(k).flatValue){if(n>=this._maxResults){var p=l.splice(n,1)[0];l.splice(this._maxResults-1,0,p)}break}}return l};j.prototype.buildData=function(k){"use strict";var l=[],m=Math.min(k.length,this._maxResults);for(var n=0;n<m;++n)l.push(this.getEntry(k[n]));return l};j.prototype.findBestPreviousQuery=function(k,l){"use strict";__p&&__p();var m=0,n=null;if(this._queryExactMatch)return Object.prototype.hasOwnProperty.call(l,k)?k:null;for(var o in l)if(k.indexOf(o)===0&&o.length>m){m=o.length;n=o}return n};j.prototype.findQueryCache=function(k){"use strict";var l=this.findBestPreviousQuery(k,this.getQueryCache());return this.getQueryCache()[l]||[]};j.prototype.buildQueryResults=function(k){"use strict";var l=this.tokenizeBackend(k).flatValue,m=this.findQueryCache(l);if(Object.prototype.hasOwnProperty.call(this.getQueryCache(),l))return m;var n=this.filterQueryResults(l,m);return n};j.prototype.filterQueryResults=function(k,l){"use strict";var m=this._alwaysPrefixMatch?c("TokenizeUtil").isPrefixMatch:c("TokenizeUtil").isQueryMatch;return l.filter(function(n){return m(k,this.getTextToIndex(this.getEntry(n)))},this)};j.prototype.buildCacheResults=function(k,l){"use strict";__p&&__p();var m=this.tokenizeCache(k,this._alwaysPrefixMatch),n=this._alwaysPrefixMatch?m.sortedTokens:m.tokens,o=n.length,p=m.isPrefixQuery?o-1:null,q={},r={},s={},t=[],u=false,v={},w=0;for(var x=0;x<o;++x){var y=n[x];if(!Object.prototype.hasOwnProperty.call(v,y)){w++;v[y]=true}else continue;for(var z in l)if(!Object.prototype.hasOwnProperty.call(q,z)&&z===y||(this._alwaysPrefixMatch||p===x)&&this.cacheUnicodeMatch.prefixMatch(z,y)){if(z===y){if(Object.prototype.hasOwnProperty.call(r,z))u=true;q[z]=true}else{if(Object.prototype.hasOwnProperty.call(q,z)||Object.prototype.hasOwnProperty.call(r,z))u=true;r[z]=true}for(var A in l[z])if(x===0||Object.prototype.hasOwnProperty.call(s,A)&&s[A]==w-1)s[A]=w}}for(var B in s)if(s[B]==w)t.push(B);if(u||w<o)t=this.filterQueryResults(k,t);if(this._titleFields&&this._titleFields.length>0)t=this.filterNonTitleMatchQueryResults(k,t);return t};j.prototype.filterNonTitleMatchQueryResults=function(k,l){"use strict";return l.filter(function(m){var n=this.tokenizeCache(k),o=n.tokens.length;if(o===0)return true;var p=this.getTitleTerms(this.getEntry(m)),q=n.tokens[0];return o===1||this._alwaysPrefixMatch?c("TokenizeUtil").isPrefixMatch(q,p)||this.cacheUnicodeMatch.prefixMatch(p,q):c("TokenizeUtil").isQueryMatch(q,p)},this)};j.prototype.getTitleTerms=function(k){"use strict";if(!k.titleToIndex)k.titleToIndex=this.getTextToIndexFromFields(k,this._titleFields);return k.titleToIndex};j.prototype.deduplicateByKey=function(k){"use strict";if(!this._deduplicationKey)return k;var l=c("createObjectFrom")(k.map(this._getDeduplicationKey.bind(this)),k);return k.filter(function(m){return l[this._getDeduplicationKey(m)]==m}.bind(this))};j.prototype._getDeduplicationKey=function(k){"use strict";var l=this.getEntry(k);if(l[this._deduplicationKey])return l[this._deduplicationKey]+"";else return"__"+k+"__"};j.prototype.getQueryCache=function(){"use strict";return this.queryCache};j.prototype.getQueryIDs=function(){"use strict";return this.queryIDs};j.prototype.setMaxResults=function(k){"use strict";this._maxResults=k;this.value&&this.respond(this.value,this.buildUids(this.value))};j.prototype.getMaxResults=function(){"use strict";return this._maxResults};j.prototype.updateToken=function(k){"use strict";this.token=k;this.dirty();return this};j.prototype.getResponseHeaderValue=function(k){"use strict";var l="";if(this.transport){l=this.transport.getResponseHeader(k);if(!l)l=""}return l};j.prototype._guid=function(){"use strict";var k=Date.now(),l="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(m){var n=Math.floor((k+Math.random()*16)%16);k=Math.floor(k/16);var o=(m=="x"?n:n&7|8).toString(16);return o});return l};Object.assign(j.prototype,{events:["bootstrap","query","respond"],asyncErrorHandler:c("emptyFunction")});f.exports=j}),null);