if (self.CavalryLogger) { CavalryLogger.start_js(["G\/VuK"]); }

__d("MercurySearchSnippetResults",["MercuryAPIArgsSource","MercuryIDs","MercuryPayloadSource","MercuryServerPayloadPreprocessor","MercurySingletonMixin","MercuryThreadlistConstants","MercuryThreadIDMap","MessengerEnvironment","messengerGraphQLThreadFetcherRe","RangedCallbackManager","MercuryServerDispatcher"],(function a(b,c,d,e,f,g){__p&&__p();var h=c("MessengerEnvironment").messengerui?c("MercuryAPIArgsSource").MESSENGER:c("MercuryAPIArgsSource").WEBMESSENGER,i={},j={},k=null,l=c("MercuryThreadlistConstants").WEBMESSENGER_SEARCH_SNIPPET_COUNT,m=c("MercuryThreadlistConstants").WEBMESSENGER_SEARCH_SNIPPET_LIMIT,n=c("MercuryThreadlistConstants").WEBMESSENGER_SEARCH_SNIPPET_MORE;function o(x){"use strict";this.$MercurySearchSnippetResults1=x;this.$MercurySearchSnippetResults2=c("MercuryServerPayloadPreprocessor").getForFBID(x);c("MercuryServerDispatcher").registerEndpoints({"/ajax/mercury/search_snippets.php":{request_user_id:x,mode:c("MercuryServerDispatcher").IMMEDIATE,handler:function(y){this.handleUpdate(y)}.bind(this)}});this.$MercurySearchSnippetResults3=c("MercuryThreadIDMap").getForFBID(x)}o.prototype.getFBID=function(){"use strict";return this.$MercurySearchSnippetResults1};o.prototype.getThreadIDMap=function(){"use strict";return this.$MercurySearchSnippetResults3};o.prototype.getAllThreadSearchResults=function(x,y){"use strict";if(x)p(this.$MercurySearchSnippetResults1,x,m,0,y)};o.prototype.getAllLocalThreadSearchResults=function(x,y){"use strict";if(x){var z=i[x];if(z){var A=z.getCurrentArraySize();p(this.$MercurySearchSnippetResults1,x,0,A,y)}}};o.prototype.getAllThreadSearchMoreResults=function(x,y){"use strict";if(x){var z=i[x];if(z){var A=z.getCurrentArraySize();p(this.$MercurySearchSnippetResults1,x,n,A,y)}}};o.prototype.getSingleThreadSearchResults=function(x,y,z){"use strict";if(!x||!y)return;q.call(this,x,y,l,0,z)};o.prototype.getSingleThreadSearchMoreResults=function(x,y,z){"use strict";__p&&__p();if(!x||!y)return;if(!j[y])return;var A=j[y][x];if(A){var B=A.num_total_snippets,C=A.snippets_cbm.getCurrentArraySize(),D=B-C;if(D>0){var E=D>n?n:D;q.call(this,x,y,E,C,z)}}};o.prototype.countSnippetsMatchingQueryInThread=function(x,y){"use strict";var z=j[y][x];if(z)return z.num_total_snippets};o.prototype.findIndexOfSnippet=function(x,y,z,A){"use strict";var B=v(x,y),C=B.getAllResources();for(var D=0;D<C.length;D++)if(z===C[D].message_id)return D};o.prototype.findSnippetAtIndex=function(x,y,z,A){"use strict";s(x,y,z);t.call(this,x,y,z,A)};o.prototype.handleUpdate=function(x){"use strict";__p&&__p();if(x.graphql_payload){var y=(x.graphql_payload.message_threads||[]).map(function(P){return c("messengerGraphQLThreadFetcherRe").transformThread(this.$MercurySearchSnippetResults1,P,x.is_page)}.bind(this));this.$MercurySearchSnippetResults2.handleUpdate({threads:y,payload_source:c("MercuryPayloadSource").SERVER_SEARCH})}else if(x.mercury_payload)this.$MercurySearchSnippetResults2.handleUpdate(x.mercury_payload);var z=x.search_snippets||{};Object.keys(z).filter(function(C){return!!z[C]}).forEach(function(C){Object.keys(z[C]).forEach(function(H){if(!z[C][H].snippets)return;z[C][H].snippets.forEach(function(P){P.matched_keywords=r(P.matched_keywords)})})});var A=x.offset,B=[];for(var C in z){var D=z[C];for(var E in D){var F=D[E],G=x.other_user_fbid||x.thread_fbid,H=this.$MercurySearchSnippetResults3.getClientIDFromServerIDNow(E),I=F.snippets,J=v(C,H),K=J.getCurrentArraySize();if(!G){B.push(H);if(K)continue}else if(A!=K)continue;var L=j[H][C];L.num_total_snippets=F.num_total_snippets;var M=I?I.length:0;if(M>0)J.addResourcesWithoutSorting(I,K);if(!G||x.limit>M)if(J.getCurrentArraySize()==L.num_total_snippets)J.setReachedEndOfArray()}if(!G){var N=u(C),O=N.getCurrentArraySize();if(A==O){N.addResourcesWithoutSorting(B,O);if(x.limit>B.length)N.setReachedEndOfArray()}}}};function p(x,y,z,A,B){__p&&__p();if(k)if(!k.thread_id){var C=u(k.query);C.unsubscribe(k.subscriber_id);k=null}var C=u(y),D=A+z,E=C.executeOrEnqueue(0,D,function(H){var I={};for(var J=0;J<H.length;J++){var K=H[J],L=j[K][y];I[K]={num_total_snippets:L.num_total_snippets,snippets:L.snippets_cbm.getAllResources()}}var M=C.hasReachedEndOfArray();B(I,M)}),F=C.getUnavailableResources(E);if(F.length){k={query:y,thread_id:null,subscriber_id:E};var G={query:y,offset:A,limit:z+1,snippetLimit:l};G.identifier="thread_fbid";w(G,x)}}function q(x,y,z,A,B){__p&&__p();if(k)if(k.thread_id){var C=v(k.query,k.thread_id);C.unsubscribe(k.subscriber_id);k=null}var C=v(x,y),D=A+z,E=C.executeOrEnqueue(0,D,function(){var K=C.getAllResources(),D=j[y][x].num_total_snippets;B(K,D)}),F=C.getUnavailableResources(E);if(F.length){k={query:x,thread_id:y,subscriber_id:E};var G={query:x,snippetOffset:A,snippetLimit:z},H=this.getThreadIDMap().getServerIDFromClientIDNow(y),I=c("MercuryIDs").tokenize(y),J=I.type;if(J=="user")G.other_user_fbid=H;else G.thread_fbid=H;G.identifier="thread_fbid";w(G,this.getFBID())}}function r(x){if(x instanceof Array){var y={};for(var z=0;z<x.length;z++)y[z.toString()]=x[z];return y}else return x}function s(x,y,z){}function t(x,y,z,A){var B=j[y][x],C=B.snippets_cbm.getAllResources(),D=B.num_total_snippets,E=C.length;if(z<E){A(C[z].message_id);return}var F=D-E,G=F>n?n:F;q.call(this,x,y,G,E,function(H,I){t.call(this,x,y,z,A)})}function u(x){if(!i[x])i[x]=new(c("RangedCallbackManager"))();return i[x]}function v(x,y){if(!j[y])j[y]={};var z=j[y][x];if(!z){z={num_total_snippets:-1,snippets_cbm:new(c("RangedCallbackManager"))()};j[y][x]=z}return z.snippets_cbm}function w(x,y){x.client=h;c("MercuryServerDispatcher").trySend("/ajax/mercury/search_snippets.php",x,null,y)}Object.assign(o,c("MercurySingletonMixin"));f.exports=o}),null);